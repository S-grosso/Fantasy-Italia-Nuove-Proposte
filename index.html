<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Italia — Nuove proposte</title>

<!-- Indicizzazione (no tracciamento) -->
<meta name="description" content="Catalogo gratuito della narrativa fantasy italiana: esordi, sinossi, dati bibliografici e segnalazioni. Nessun cookie né affiliazioni." />
<meta name="robots" content="index, follow, max-image-preview:large" />
<meta name="referrer" content="no-referrer" />
<meta name="theme-color" content="#7aa6ff" />
<meta property="og:title" content="Fantasy Italia — Nuove proposte" />
<meta property="og:description" content="Catalogo gratuito della narrativa fantasy italiana: esordi, sinossi, dati bibliografici e segnalazioni." />

<style>
  :root{
    --bg:#0f1013; --panel:#171923; --ink:#e7e9ee; --muted:#a9adbb;
    --accent:#7aa6ff; --danger:#ff6b6b; --border:#232635;
    --amz:#131a22; /* nero Amazon */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,Noto Sans;background:linear-gradient(180deg,#0f1013,#0d0e12 140vh);color:var(--ink)}

  /* Header */
  header{position:sticky;top:0;z-index:10;background:rgba(13,14,18,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  .rowbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px;letter-spacing:.2px;flex:1}
  .adminBadge{display:none;font-size:12px;border:1px solid var(--border);padding:6px 9px;border-radius:999px;color:#cfe}
  .adminToggle{background:#132033;border:1px solid var(--border);color:#dfe;padding:8px 12px;border-radius:10px;cursor:pointer}

  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:#151826;color:var(--ink);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  nav button.active{outline:2px solid var(--accent)}

  /* Layout */
  main{padding:20px 16px}
  section{max-width:1100px;margin:0 auto;background:#171923;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{position:relative;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:flex-start;min-height:140px}
  .badge{position:absolute;top:8px;left:8px;background:#0f2;color:#061;font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #063}
  img.cover{display:block;border-radius:8px;border:1px solid var(--border);height:160px;width:auto;object-fit:cover;background:#080a0f}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0 0 6px;font-size:16px;line-height:1.2}
  .meta .by{color:var(--muted);font-size:13px;margin-bottom:6px}
  .meta .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:12px;padding:4px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .tag.label{color:#9fc8ff;border-color:#2854aa}
  .actions{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:nowrap}

  .btn{background:#151826;border:1px solid var(--border);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
  .btn.primary{outline:2px solid var(--accent)}
  .btn.danger{outline:1px solid #402;color:#ff9aa9}
  .btn.small{font-size:12px;padding:6px 8px}

  /* Store buttons: 35x100, stesso sfondo */
  .btn-amz, .btn-store{
    width:100px; height:35px; padding:0;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:10px; border:1px solid #0c0e14;
    background:var(--amz); color:#fff; text-decoration:none;
    flex:0 0 100px;
  }
  .btn-amz img{display:block;max-height:70%;max-width:90%;object-fit:contain}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:180px}
  .field label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="url"], input[type="number"], textarea, select{background:#0f1119;color:#fff;border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  textarea{height:120px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .banner{display:none;background:#142036;border:1px solid #223a66;color:#cfe;border-radius:12px;padding:8px 12px;margin:8px 0}

  /* News */
  .news-card{display:block;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:12px;text-decoration:none;color:inherit;cursor:pointer}
  .news-card h3{margin:0 0 6px 0;font-size:18px}
  .line-clamp{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
  .news-admin-actions{display:flex;gap:8px;margin-top:10px}

  /* Pagina notizia */
  .news-article{max-width:900px;margin:0 auto;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:16px}
  .backRow{margin-top:16px;display:flex;gap:10px}

  /* Footer */
  footer{color:var(--muted);font-size:12px;padding:16px;text-align:center}
  footer a{color:#9fc8ff;text-decoration:none}
  footer .sep{opacity:.4;margin:0 8px}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="rowbar">
      <h1>Fantasy Italia — Nuove proposte</h1>
      <span id="adminBadge" class="adminBadge"></span>
      <button id="adminToggle" class="adminToggle" title="Accedi/Esci come admin">Accedi admin</button>
    </div>
    <div class="rowbar" style="margin-top:8px">
      <nav id="navPublic">
        <button data-tab="catalogo" class="active">Catalogo</button>
        <button data-tab="nuovo">Nuovo titolo</button>
        <button data-tab="notizie">Notizie</button>
      </nav>
      <nav id="navAdmin" style="display:none">
        <button data-tab="moderazione">Moderazione</button>
        <button data-tab="impostazioni">Impostazioni</button>
      </nav>
    </div>
  </div>
</header>

<main>
  <!-- Catalogo -->
  <section id="catalogo" class="tab">
    <div id="banner" class="banner"></div>

    <div class="toolbar">
      <div class="field" style="max-width:200px">
        <label>Anno ≥</label>
        <select id="filterYear">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="all" selected>Tutti</option>
        </select>
      </div>
      <input id="q" type="text" placeholder="Cerca titolo, autore, editore…" style="flex:1;min-width:200px" />
      <span id="adminTools" style="display:none;gap:8px">
        <button class="btn right" id="btnExport">Esporta JSON</button>
      </span>
    </div>

    <div id="gridCatalogo" class="grid"></div>
  </section>

  <!-- Nuovo titolo -->
  <section id="nuovo" class="tab" style="display:none">
    <div class="toolbar">
      <div class="small muted">I campi con (*) sono obbligatori. I titoli restano <b>in revisione</b> finché non vengono approvati da un admin.</div>
    </div>

    <div class="row">
      <div class="field"><label>Titolo *</label><input id="f_title" type="text" /></div>
      <div class="field"><label>Autore *</label><input id="f_author" type="text" /></div>
      <div class="field"><label>Editore *</label><input id="f_publisher" type="text" /></div>
      <div class="field" style="max-width:120px"><label>Anno *</label><input id="f_year" type="number" min="1900" max="2100" value="2025" /></div>
      <div class="field" style="max-width:200px">
        <label>Esordio</label>
        <select id="f_debut">
          <option value="unknown" selected>Non specificato</option>
          <option value="yes">Sì</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field"><label>ISBN</label><input id="f_isbn" type="text" placeholder="978-..." /></div>
      <div class="field"><label>URL copertina</label><input id="f_cover" type="url" placeholder="https://..." /></div>
    </div>

    <div class="row">
      <div class="field"><label>Store Amazon</label><input id="f_amz" type="url" placeholder="https://amazon..." /></div>
      <div class="field"><label>Store editore</label><input id="f_store" type="url" placeholder="https://..." /></div>
    </div>

    <div class="field">
      <label>Sinossi</label>
      <textarea id="f_desc"></textarea>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnSaveNew">Salva in revisione</button>
    </div>
  </section>

  <!-- Notizie: lista -->
  <section id="notizie" class="tab" style="display:none">
    <div class="toolbar">
      <div class="muted small">Aggiornamenti e segnalazioni dal catalogo.</div>
      <span id="newsAdminBar" style="display:none; margin-left:auto; gap:8px">
        <button class="btn" id="btnExportNews">Esporta news (JSON)</button>
      </span>
    </div>

    <div id="newsEditor" class="banner" style="display:none">
      <div class="row">
        <div class="field"><label>Titolo notizia</label><input id="news_title" type="text" /></div>
      </div>
      <div class="field">
        <label>Contenuto (formattato)</label>
        <div class="toolbar" style="gap:6px">
          <button type="button" class="btn small" data-cmd="bold"><b>B</b></button>
          <button type="button" class="btn small" data-cmd="italic"><i>I</i></button>
          <button type="button" class="btn small" data-cmd="underline"><u>U</u></button>
          <button type="button" class="btn small" data-cmd="bigger">A+</button>
          <button type="button" class="btn small" data-cmd="smaller">A−</button>
          <button type="button" class="btn small" data-cmd="ul">• Lista</button>
          <button type="button" class="btn small" data-cmd="link">🔗 Link</button>
          <button type="button" class="btn small" data-cmd="clear">✖︎ Pulisci</button>
        </div>
        <div id="news_body_html" contenteditable="true" spellcheck="true" style="background:#0f1119;color:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:140px;line-height:1.5"></div>
        <div class="hint">L’anteprima della card viene dalle prime righe del testo.</div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnSaveNews">Pubblica notizia</button>
      </div>
    </div>

    <div id="gridNews" class="grid"></div>
  </section>

  <!-- Notizia: pagina articolo -->
  <section id="newsview" class="tab" style="display:none">
    <div class="news-article">
      <button class="btn" id="btnBackTop">◀︎ Torna all’app</button>
      <h2 id="articleTitle" style="margin:10px 0 4px 0"></h2>
      <div id="articleMeta" class="muted small" style="margin-bottom:10px"></div>
      <div id="articleBody" class="news-body"></div>
      <div class="backRow"><button class="btn" id="btnBackBottom">◀︎ Torna all’app</button></div>
    </div>
  </section>

  <!-- Moderazione -->
  <section id="moderazione" class="tab" style="display:none">
    <div class="toolbar">
      <div class="field" style="max-width:220px">
        <label>Mostra</label>
        <select id="moderationFilter">
          <option value="pending" selected>In revisione</option>
          <option value="approved">Approvati</option>
          <option value="all">Tutti</option>
        </select>
      </div>
    </div>
    <div id="gridModeration" class="grid"></div>
  </section>

  <!-- Impostazioni -->
  <section id="impostazioni" class="tab" style="display:none">
    <h3>Impostazioni sito</h3>
    <div class="small muted" style="margin-bottom:10px">Gli URL remoti consentono di centralizzare credenziali e dati.</div>
    <div class="row">
      <div class="field"><label>URL remoto admins.json</label><input id="adminsUrl" type="url" placeholder="/data/admins.json" /></div>
      <div class="field"><label>URL remoto catalogo.json</label><input id="catalogUrl" type="url" placeholder="/data/catalogo.json" /></div>
      <div class="field"><label>URL remoto news.json</label><input id="newsUrl" type="url" placeholder="/data/news.json" /></div>
      <button class="btn" id="btnSaveUrls">Salva URL</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnClearLocal">Svuota cache locale</button>
      <button class="btn" id="btnForceReload">Ricarica dal remoto (sovrascrivi)</button>
    </div>
    <div class="divider"></div>
    <h3>Amministratori</h3>
    <div class="small muted">Login PBKDF2 (salt/iter) da <a href="admin-tool.html" target="_blank" rel="noopener">admin-tool</a>.</div>
    <div class="actions" style="margin-top:12px">
      <button class="btn danger" id="btnLogout">Esci dalla sessione admin</button>
    </div>
  </section>
</main>

<footer>
  <div>Fantasy Italia — Nuove proposte è un catalogo collaborativo dedicato alla narrativa fantasy italiana contemporanea.</div>
  <div style="margin-top:6px">
    <a href="legal.html">Note legali & privacy</a><span class="sep">•</span>
    <a href="mailto:simonegrosso.writer@gmail.com">Contatti</a>
  </div>
</footer>

<script>
(function(){
  'use strict';
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  /* === Config & stato === */
  const APP_VERSION = 'v3.9.1-cachefix2';
  const state = {
    settings: load('fi_settings_site_v38', {adminsUrl:'', catalogUrl:'', newsUrl:''}),
    remoteAdmins: [],
    books: load('fi_books_site_v38', []),
    news:  load('fi_news_site_v38', []),
    isAdmin: false,
    meUser: null,
    newsReady: false
  };

  const DEFAULT_BASE = location.origin + location.pathname.replace(/\\/[^\\/]*$/, '/');
  const DEFAULTS = {
    adminsUrl:  DEFAULT_BASE + 'data/admins.json',
    catalogUrl: DEFAULT_BASE + 'data/catalogo.json',
    newsUrl:    DEFAULT_BASE + 'data/news.json'
  };
  if(!state.settings.adminsUrl)  state.settings.adminsUrl  = DEFAULTS.adminsUrl;
  if(!state.settings.catalogUrl) state.settings.catalogUrl = DEFAULTS.catalogUrl;
  if(!state.settings.newsUrl)    state.settings.newsUrl    = DEFAULTS.newsUrl;
  save('fi_settings_site_v38', state.settings);

  function load(k, fb){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(fb)); }catch(e){ return fb; } }
  function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  /* Cache-busting helper */
  function withBust(url){
    try{
      const u=new URL(url, location.href);
      if(!u.searchParams.get('v')) u.searchParams.set('v', Date.now().toString());
      return u.toString();
    }catch(_){
      return url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    }
  }
  async function fetchJson(url){ const res=await fetch(withBust(url), {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }

  /* Admin sessione */
  function sessionIsValid(){
    const u=sessionStorage.getItem('fi_admin_user');
    const t=+sessionStorage.getItem('fi_admin_time')||0;
    if(!u||Date.now()-t>4*60*60*1000) return false;
    if(Array.isArray(state.remoteAdmins) && state.remoteAdmins.length){
      return state.remoteAdmins.some(a=>a.u===u);
    }
    return true;
  }
  function touchSession(){ sessionStorage.setItem('fi_admin_time', String(Date.now())); }
  function clearSession(){ sessionStorage.removeItem('fi_admin_user'); sessionStorage.removeItem('fi_admin_time'); }

  async function pbkdf2Hex(pass, saltHex, iters, length=32){
    const enc=new TextEncoder();
    const key=await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveBits']);
    const salt=new Uint8Array((saltHex.match(/.{1,2}/g)||[]).map(b=>parseInt(b,16)));
    const bits=await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations:iters}, key, length*8);
    return [...new Uint8Array(bits)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  async function doLoginFlow(){
    const u=prompt('Inserisci username admin'); if(u===null||!u.trim()) return false;
    const p=prompt('Inserisci password'); if(p===null) return false;
    try{
      if(!state.remoteAdmins.length){ state.remoteAdmins = await fetchJson(state.settings.adminsUrl); }
      const rec = state.remoteAdmins.find(a=>a.u===u.trim());
      if(!rec){ alert('Utente non trovato.'); return false; }
      const h = await pbkdf2Hex(p, rec.salt, rec.iter||120000, 32);
      if(h!==rec.hash){ alert('Password errata.'); return false; }
      sessionStorage.setItem('fi_admin_user', rec.u); touchSession();
      state.isAdmin=true; state.meUser=rec.u;
      applyAdminUI();
      alert('Accesso admin eseguito.');
      return true;
    }catch(e){ alert('Errore durante il login.'); return false; }
  }

  /* Normalizzazione libri: status di default approved (per i vecchi JSON) */
  function normalizeBook(x){
    const b={...x};
    if(b.status==null||b.status==='') b.status='approved';
    if(!Array.isArray(b.labels)) b.labels = b.labels ? [].concat(b.labels) : [];
    b.featured=!!b.featured;
    return b;
  }

  /* Bootstrap dal remoto se locale vuoto */
  async function bootstrapIfEmpty(){
    if((state.books||[]).length && (state.news||[]).length) return;
    try{
      const [c, n] = await Promise.allSettled([ fetchJson(state.settings.catalogUrl), fetchJson(state.settings.newsUrl) ]);
      if(c.status==='fulfilled' && Array.isArray(c.value)){ state.books=c.value.map(normalizeBook); save('fi_books_site_v38', state.books); }
      if(n.status==='fulfilled' && Array.isArray(n.value)){ state.news=(n.value||[]).map((x,i)=>({id:x.id||('n'+i), title:x.title, bodyHtml:x.bodyHtml||x.body||'', ts:x.ts||Date.now()})); save('fi_news_site_v38', state.news); }
      renderCatalogo(); renderNews();
    }catch(_){ /* banner già visibile se fallisce tutto */ }
  }

  /* === UI admin === */
  function applyAdminUI(){
    const on=sessionIsValid();
    $('#navAdmin').style.display = on ? 'flex' : 'none';
    $('#adminTools').style.display = on ? 'flex' : 'none';
    $('#adminBadge').style.display = on ? 'inline-block' : 'none';
    $('#adminBadge').textContent  = on ? ('Admin: '+(sessionStorage.getItem('fi_admin_user')||'')) : '';
    $('#adminToggle').textContent = on ? 'Esci admin' : 'Accedi admin';
    $('#newsAdminBar').style.display = on ? 'flex' : 'none';
    $('#newsEditor').style.display   = on ? '' : 'none';
  }
  $('#adminToggle').addEventListener('click', async()=>{
    if(sessionIsValid()){ clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.'); }
    else await doLoginFlow();
  });
  $('#btnLogout').addEventListener('click', ()=>{ clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.'); });

  /* === Impostazioni === */
  $('#btnSaveUrls').addEventListener('click', ()=>{
    state.settings.adminsUrl=$('#adminsUrl').value.trim()||DEFAULTS.adminsUrl;
    state.settings.catalogUrl=$('#catalogUrl').value.trim()||DEFAULTS.catalogUrl;
    state.settings.newsUrl=$('#newsUrl').value.trim()||DEFAULTS.newsUrl;
    save('fi_settings_site_v38', state.settings);
    alert('URL salvati. Ricarica la pagina.');
  });
  $('#btnClearLocal').addEventListener('click', ()=>{
    localStorage.removeItem('fi_books_site_v38');
    localStorage.removeItem('fi_news_site_v38');
    state.books=[]; state.news=[];
    renderCatalogo(); renderNews();
    location.reload();
  });
  $('#btnForceReload').addEventListener('click', async()=>{
    try{
      const [c,n] = await Promise.all([ fetchJson(state.settings.catalogUrl), fetchJson(state.settings.newsUrl) ]);
      if(Array.isArray(c)){ state.books=c.map(normalizeBook); save('fi_books_site_v38', state.books); }
      if(Array.isArray(n)){ state.news=(n||[]).map((x,i)=>({id:x.id||('n'+i), title:x.title, bodyHtml:x.bodyHtml||x.body||'', ts:x.ts||Date.now()})); save('fi_news_site_v38', state.news); }
      renderCatalogo(); renderNews();
      alert('Ricaricati dal remoto.');
    }catch(e){ alert('Errore ricarica dal remoto.'); }
  });

  /* === Nuovo titolo === */
  function collectForm(){
    const title=($('#f_title').value||'').trim();
    const author=($('#f_author').value||'').trim();
    const publisher=($('#f_publisher').value||'').trim();
    const year=parseInt($('#f_year').value,10);
    if(!title||!author||!publisher||!year){ alert('Compila titolo, autore, editore e anno.'); return null; }
    const b={
      id: 'b'+Date.now().toString(36),
      title, author, publisher, year,
      isbn: ($('#f_isbn').value||'').trim(),
      coverUrl: ($('#f_cover').value||'').trim(),
      description: ($('#f_desc').value||'').trim(),
      storeAmazonUrl: ($('#f_amz').value||'').trim(),
      storePublisherUrl: ($('#f_store').value||'').trim(),
      isDebut: (function(){ const v=$('#f_debut').value; if(v==='yes') return true; if(v==='no') return false; return null; })(),
      labels:[], featured:false, status:'pending'
    };
    return b;
  }
  function clearForm(){ ['f_title','f_author','f_publisher','f_isbn','f_cover','f_desc','f_amz','f_store'].forEach(id=>{$('#'+id).value='';}); $('#f_year').value=new Date().getFullYear(); $('#f_debut').value='unknown'; }
  $('#btnSaveNew').addEventListener('click', ()=>{
    const b=collectForm(); if(!b) return;
    if(!Array.isArray(state.books)) state.books=[];
    state.books.push(b);
    save('fi_books_site_v38', state.books);
    clearForm();
    renderModeration(); // visibile qui
    renderCatalogo();   // NON visibile (pending)
    alert('Titolo salvato in revisione.');
  });

  /* === Catalogo === */
  function placeholderCover(){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="160" viewBox="0 0 120 160"><rect width="100%" height="100%" fill="#0b0e13"/><rect x="10" y="10" width="100" height="140" rx="8" ry="8" fill="#0f141d" stroke="#1d2230"/><text x="60" y="83" text-anchor="middle" font-family="ui-sans-serif,system-ui" font-size="14" fill="#5e657a">Copertina</text></svg>');
  }
  function tagEl(t, cls){ const s=document.createElement('span'); s.className=cls||'tag'; s.textContent=t; return s; }
  function bookCard(b){
    const el=document.createElement('div'); el.className='card';
    if(b.featured){ const bd=document.createElement('div'); bd.className='badge'; bd.textContent='Consigliato'; el.appendChild(bd); }
    const img=document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src=b.coverUrl||placeholderCover();
    const meta=document.createElement('div'); meta.className='meta';
    const h3=document.createElement('h3'); h3.textContent=b.title||'(Senza titolo)';
    const by=document.createElement('div'); by.className='by'; by.textContent=[b.author,b.publisher,b.year].filter(Boolean).join(' • ');
    const desc=document.createElement('div'); desc.className='small muted'; desc.textContent=(b.description||'').length>200? (b.description.slice(0,199)+'…') : (b.description||'');
    const tags=document.createElement('div'); tags.className='tags';
    tags.appendChild(tagEl(b.isDebut===true?'Esordio: sì':b.isDebut===false?'Esordio: no':'Esordio: ?'));
    if(Array.isArray(b.labels)) b.labels.slice(0,6).forEach(l=>tags.appendChild(tagEl(l,'tag label')));

    const actions=document.createElement('div'); actions.className='actions';
    if(b.storeAmazonUrl){
      const a=document.createElement('a'); a.href=b.storeAmazonUrl; a.target='_blank'; a.rel='noopener'; a.className='btn-amz'; a.title='Amazon'; a.setAttribute('aria-label','Apri su Amazon');
      const logo=document.createElement('img'); logo.src='Logo Amazon.png'; logo.alt='Amazon';
      a.appendChild(logo);
      actions.appendChild(a);
    }
    if(b.storePublisherUrl){
      const s=document.createElement('a'); s.href=b.storePublisherUrl; s.target='_blank'; s.rel='noopener'; s.className='btn btn-store'; s.textContent='Store editore';
      actions.appendChild(s);
    }

    meta.appendChild(h3); meta.appendChild(by); meta.appendChild(desc); meta.appendChild(tags); meta.appendChild(actions);
    el.appendChild(img); el.appendChild(meta);
    return el;
  }
  function renderCatalogo(){
    const grid=$('#gridCatalogo'); grid.innerHTML='';
    let list = Array.isArray(state.books) ? state.books.slice() : [];
    /* MOSTRA SOLO APPROVATI */
    list = list.filter(b=> (b.status||'approved')==='approved');

    const q=($('#q').value||'').toLowerCase().trim();
    const fy=$('#filterYear').value;
    if(fy!=='all'){ const y=parseInt(fy,10)||0; list=list.filter(b=>(+b.year||0)>=y); }
    if(q){ list=list.filter(b=>[b.title,b.author,b.publisher,(b.labels||[]).join(' ')].filter(Boolean).join(' ').toLowerCase().includes(q)); }
    list.sort((a,b)=>{ if(!!b.featured!==!!a.featured) return (b.featured?1:0)-(a.featured?1:0); const ya=(+a.year||0), yb=(+b.year||0); if(ya!==yb) return yb-ya; return (a.title||'').localeCompare(b.title||'','it'); });
    if(!list.length){ grid.innerHTML='<div class="muted">Nessun risultato.</div>'; return; }
    list.forEach(b=>grid.appendChild(bookCard(b)));
  }
  $('#filterYear').addEventListener('change', renderCatalogo);
  (function(){let t; $('#q').addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(renderCatalogo,200); });})();
  $('#btnExport').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state.books,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogo.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  /* === Moderazione === */
  function modCard(b){
    const el=document.createElement('div'); el.className='card';
    const img=document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src=b.coverUrl||placeholderCover();
    const meta=document.createElement('div'); meta.className='meta';
    const h3=document.createElement('h3'); h3.textContent=b.title||'(Senza titolo)';
    const by=document.createElement('div'); by.className='by'; by.textContent=[b.author,b.publisher,b.year].filter(Boolean).join(' • ');

    const labelsWrap=document.createElement('div'); labelsWrap.className='tags';
    function refreshLabels(){ labelsWrap.innerHTML=''; (b.labels||[]).forEach(l=>labelsWrap.appendChild(tagEl(l,'tag label'))); }
    refreshLabels();

    const row=document.createElement('div'); row.className='row';
    const inLab=document.createElement('input'); inLab.type='text'; inLab.placeholder='Nuova etichetta'; inLab.style.minWidth='160px';
    const addBtn=document.createElement('button'); addBtn.className='btn small'; addBtn.textContent='Aggiungi';
    addBtn.addEventListener('click',()=>{ const v=(inLab.value||'').trim(); if(!v) return; if(!Array.isArray(b.labels)) b.labels=[]; if(!b.labels.includes(v)) b.labels.push(v); inLab.value=''; save('fi_books_site_v38', state.books); refreshLabels(); renderCatalogo(); });

    const featWrap=document.createElement('label'); featWrap.className='small muted'; featWrap.style.display='inline-flex'; featWrap.style.alignItems='center'; featWrap.style.gap='6px';
    const featChk=document.createElement('input'); featChk.type='checkbox'; featChk.checked=!!b.featured;
    featChk.addEventListener('change', ()=>{ b.featured=!!featChk.checked; save('fi_books_site_v38', state.books); renderCatalogo(); });
    featWrap.appendChild(featChk); featWrap.append('Consigliato');

    const debutSel=document.createElement('select');
    [['unknown','Non specificato'],['yes','Sì'],['no','No']].forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; debutSel.appendChild(o); });
    debutSel.value = (b.isDebut===true?'yes':b.isDebut===false?'no':'unknown');
    debutSel.addEventListener('change', ()=>{ const v=debutSel.value; b.isDebut=(v==='yes')?true:(v==='no')?false:null; save('fi_books_site_v38', state.books); renderCatalogo(); });

    const actions=document.createElement('div'); actions.className='actions';
    const approve=document.createElement('button'); approve.className='btn primary'; approve.textContent=(b.status==='approved')?'Revoca approvazione':'Approva';
    approve.addEventListener('click',()=>{ b.status=(b.status==='approved')?'pending':'approved'; approve.textContent=(b.status==='approved')?'Revoca approvazione':'Approva'; save('fi_books_site_v38', state.books); renderModeration(); renderCatalogo(); });
    const saveB=document.createElement('button'); saveB.className='btn'; saveB.textContent='Salva'; saveB.addEventListener('click',()=>{ save('fi_books_site_v38', state.books); renderModeration(); renderCatalogo(); alert('Modifiche salvate.'); });

    row.appendChild(inLab); row.appendChild(addBtn);
    meta.appendChild(h3); meta.appendChild(by);
    meta.appendChild(labelsWrap); meta.appendChild(row);
    meta.appendChild(featWrap);
    const debutRow=document.createElement('div'); debutRow.className='small'; debutRow.style.marginTop='6px'; debutRow.append(' Esordio: ', debutSel);
    meta.appendChild(debutRow);
    meta.appendChild(actions); actions.appendChild(approve); actions.appendChild(saveB);

    el.appendChild(img); el.appendChild(meta);
    return el;
  }
  function renderModeration(){
    const grid=$('#gridModeration'); grid.innerHTML='';
    if(!sessionIsValid()){ grid.innerHTML='<div class="muted">Area riservata. Accedi come admin.</div>'; return; }
    let list = Array.isArray(state.books)? state.books.slice():[];
    const f=$('#moderationFilter').value;
    if(f==='pending')  list=list.filter(b=>(b.status||'pending')!=='approved');
    if(f==='approved') list=list.filter(b=>(b.status||'approved')==='approved');
    if(!list.length){ grid.innerHTML='<div class="muted">Niente da mostrare.</div>'; return; }
    list.forEach(b=>grid.appendChild(modCard(b)));
  }
  $('#moderationFilter').addEventListener('change', renderModeration);

  /* === Notizie === */
  function sanitizeHtml(html){ return (html||'').replace(/<script/gi,'&lt;script'); }
  function renderNews(){
    const grid=$('#gridNews'); grid.innerHTML='';
    const list=(state.news||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
    if(!list.length){ grid.innerHTML='<div class="muted">Ancora nessuna notizia.</div>'; return; }
    for(const n of list){
      const card=document.createElement('div'); card.className='news-card'; card.tabIndex=0;
      card.addEventListener('click', ()=>{ location.hash='#news/'+(n.id||''); });
      const h3=document.createElement('h3'); h3.textContent=n.title||'(Senza titolo)';
      const prev=document.createElement('div'); prev.className='muted line-clamp';
      const plain=(n.bodyHtml||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      prev.textContent = plain.length>360? plain.slice(0,360)+'…' : plain;
      card.appendChild(h3); card.appendChild(prev);
      grid.appendChild(card);
    }
    state.newsReady=true;
  }
  function openNewsById(id){
    const n=(state.news||[]).find(x=>String(x.id)===String(id));
    if(!n) return false;
    $('#articleTitle').textContent = n.title || '';
    $('#articleMeta').textContent  = new Date(n.ts||Date.now()).toLocaleString('it-IT');
    $('#articleBody').innerHTML    = n.bodyHtml || '';
    showTab('newsview');
    const safe=encodeURIComponent(String(id));
    history.replaceState(null,'',location.pathname+'?n='+safe+'#news/'+safe);
    return true;
  }
  function backToNews(e){ e?.preventDefault(); history.pushState(null,'',location.pathname+'#notizie'); showTab('notizie'); }

  // mini-editor
  $$('#newsEditor [data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ed=$('#news_body_html'); ed && ed.focus();
      const cmd=btn.getAttribute('data-cmd');
      if(cmd==='bold') document.execCommand('bold', false, null);
      else if(cmd==='italic') document.execCommand('italic', false, null);
      else if(cmd==='underline') document.execCommand('underline', false, null);
      else if(cmd==='ul') document.execCommand('insertUnorderedList', false, null);
      else if(cmd==='link'){ const url=prompt('Inserisci URL (https://...)'); if(url && /^https?:/i.test(url)) document.execCommand('createLink', false, url); }
      else if(cmd==='bigger' || cmd==='smaller'){ const sel=window.getSelection(); if(!sel||!sel.rangeCount) return; const range=sel.getRangeAt(0); const span=document.createElement('span'); span.style.fontSize=(cmd==='bigger'?'1.15em':'0.9em'); range.surroundContents(span); }
      else if(cmd==='clear'){ ed.innerHTML=''; }
    });
  });
  $('#btnSaveNews').addEventListener('click', (ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const title=($('#news_title').value||'').trim();
    const html=sanitizeHtml($('#news_body_html').innerHTML||'');
    if(!title){ alert('Titolo obbligatorio.'); return; }
    if(!html){ alert('Inserisci un testo.'); return; }
    const item={ id:'n'+Date.now().toString(36), title, bodyHtml:html, ts:Date.now() };
    if(!Array.isArray(state.news)) state.news=[];
    state.news.push(item);
    save('fi_news_site_v38', state.news);
    $('#news_title').value=''; $('#news_body_html').innerHTML='';
    renderNews(); alert('Notizia pubblicata.');
  });
  $('#btnExportNews').addEventListener('click', ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const blob=new Blob([JSON.stringify(state.news||[],null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='news.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  $('#btnBackTop').addEventListener('click', backToNews);
  $('#btnBackBottom').addEventListener('click', backToNews);

  /* === Navigazione / Router === */
  function showTab(tab){
    $$('.tab').forEach(s=>s.style.display='none');
    $('#'+tab).style.display='';
    $$('#navPublic button, #navAdmin button').forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
  }
  function handleRoute(){
    const hash=(location.hash||'').replace(/^#/, '');
    if(hash.startsWith('news/')){ const id=decodeURIComponent(hash.slice(5)); if(!openNewsById(id)){ alert('Articolo non trovato.'); showTab('notizie'); } return; }
    if(hash==='notizie'){ showTab('notizie'); return; }
    if(hash==='nuovo'){ showTab('nuovo'); return; }
    if(hash==='moderazione'){ if(sessionIsValid()){ renderModeration(); showTab('moderazione'); } else { alert('Area riservata: accedi come admin.'); showTab('catalogo'); } return; }
    if(hash==='impostazioni'){ if(sessionIsValid()){ showTab('impostazioni'); } else { alert('Area riservata: accedi come admin.'); showTab('catalogo'); } return; }
    showTab('catalogo');
  }
  window.addEventListener('hashchange', handleRoute);
  $$('#navPublic button, #navAdmin button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab=btn.getAttribute('data-tab');
      if(tab==='moderazione'||tab==='impostazioni'){ if(!sessionIsValid()){ alert('Area riservata: accedi come admin.'); return; } touchSession(); }
      if(tab==='moderazione') renderModeration();
      if(tab==='notizie') renderNews();
      location.hash='#'+tab;
    });
  });

  /* === Init === */
  (async function init(){
    // Pre-carica admins (se presenti)
    try{ state.remoteAdmins = await fetchJson(state.settings.adminsUrl); }catch(_){}
    if(sessionIsValid()){ state.isAdmin=true; state.meUser=sessionStorage.getItem('fi_admin_user'); touchSession(); }
    applyAdminUI();

    renderCatalogo();
    renderNews();
    bootstrapIfEmpty();

    // Fallback deep-link da query (?n= / ?news=)
    if(!location.hash){
      const p=new URLSearchParams(location.search);
      const id=p.get('n')||p.get('news');
      if(id){ history.replaceState(null,'',location.pathname+'?n='+encodeURIComponent(id)+'#news/'+encodeURIComponent(id)); }
    }
    handleRoute();
  })();

})();
</script>
</body>
</html>
