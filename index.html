<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fantasy Italia — Nuove proposte</title>
<meta name="theme-color" content="#7aa6ff">
<meta name="description" content="Catalogo gratuito della narrativa fantasy italiana: autori esordienti, collane, dati bibliografici e segnalazioni. Nessun cookie né affiliazioni.">
<meta name="robots" content="index, follow, max-image-preview:large">
<meta name="referrer" content="no-referrer">
<meta property="og:title" content="Fantasy Italia — Nuove proposte">
<meta property="og:description" content="Catalogo gratuito della narrativa fantasy italiana: autori esordienti, collane, dati bibliografici e segnalazioni. Nessun cookie né affiliazioni.">
<style>
  :root{ --bg:#0f1013; --panel:#171923; --ink:#e7e9ee; --muted:#a9adbb; --accent:#7aa6ff; --danger:#ff6b6b; --border:#232635; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,Noto Sans;background:linear-gradient(180deg,#0f1013,#0d0e12 140vh);color:var(--ink)}

  /* Header sempre sopra a tutto */
  header{position:sticky;top:0;z-index:10000;background:rgba(13,14,18,.6);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);pointer-events:auto}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  .wrap-col{display:flex;flex-direction:column;gap:8px}
  .topbar{display:flex;align-items:center;gap:10px}
  h1{font-size:20px;margin:0;letter-spacing:.2px;flex:1}
  .adminBadge{font-size:12px;border:1px solid var(--border);padding:6px 9px;border-radius:999px;color:#cfe;opacity:.9}
  .adminToggle{background:#132033;border:1px solid var(--border);color:#dfe;padding:8px 12px;border-radius:10px;cursor:pointer}

  .subnav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:#151826;color:var(--ink);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600;position:relative;z-index:10001}
  nav button.active{outline:2px solid var(--accent)}

  /* Layout */
  main{padding:20px 16px}
  section{max-width:1100px;margin:0 auto;background:#171923;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);position:relative;z-index:1}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{position:relative;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:flex-start;min-height:140px}
  .badge{position:absolute;top:8px;left:8px;background:#0f2;color:#061;font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #063}
  img.cover{display:block;border-radius:8px;border:1px solid var(--border);height:160px;width:auto;object-fit:cover;background:#080a0f}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0 0 6px 0;font-size:16px;line-height:1.2}
  .meta .by{color:var(--muted);font-size:13px;margin-bottom:6px}
  .meta .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:12px;padding:4px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .tag.label{color:#9fc8ff;border-color:#2854aa}
  .actions{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:nowrap}
  .btn{background:#151826;border:1px solid var(--border);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
  .btn.primary{outline:2px solid var(--accent)}
  .btn.danger{outline:1px solid #402;color:#ff9aa9}
  .btn.small{font-size:12px;padding:6px 8px}

  /* Store buttons: 35x100, nero Amazon */
  .btn-amz, .btn-store{
    width:100px;height:35px;padding:0;
    display:inline-flex;align-items:center;justify-content:center;
    border-radius:10px;font-size:12px;font-weight:600;letter-spacing:.2px;
    border:1px solid #0c0e14;text-decoration:none;flex:0 0 100px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .btn-amz{background:#131a22}
  .btn-amz img{display:block;max-height:70%;max-width:90%;object-fit:contain}
  .btn-store{background:#131a22;color:#fff;text-decoration:none}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:180px}
  .field label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="url"], input[type="number"], textarea, select{background:#0f1016;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  textarea{height:140px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .banner{background:#142036;border:1px solid #223a66;color:#cfe;border-radius:12px;padding:8px 12px;margin:8px 0;display:none}

  /* News */
  .news-card{display:block;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:12px;text-decoration:none;color:inherit;cursor:pointer}
  .news-card h3{margin:0 0 6px 0;font-size:18px}
  .line-clamp{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
  .news-admin-actions{display:flex;gap:8px;margin-top:10px}
  .news-article{max-width:900px;margin:0 auto;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;z-index:1}
  .backAppTop{position:sticky;top:8px;left:0;z-index:2;pointer-events:none}
  .backAppTop .btn{pointer-events:auto}
  .backRow{margin-top:16px;display:flex;gap:10px}
  .news-meta{color:var(--muted);font-size:12px;margin-bottom:10px}
  #newsEditor{position:relative;margin-bottom:14px}

  /* Footer */
  footer{color:var(--muted);font-size:12px;padding:16px;text-align:center}
  footer a{color:#9fc8ff;text-decoration:none}
  footer .sep{opacity:.4;margin:0 8px}

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
</style>
</head>
<body>

<header>
  <div class="wrap wrap-col">
    <div class="topbar">
      <h1>Fantasy Italia — Nuove proposte</h1>
      <span id="adminBadge" class="adminBadge" style="display:none"></span>
      <button id="adminToggle" class="adminToggle" title="Accedi/Esci dalla sessione amministratore">Accedi admin</button>
    </div>
    <div class="subnav">
      <nav id="navPublic">
        <button data-tab="catalogo" class="active">Catalogo</button>
        <button data-tab="nuovo">Nuovo titolo</button>
        <button data-tab="notizie">Notizie</button>
      </nav>
      <nav id="navAdmin" style="display:none">
        <button data-tab="moderazione">Moderazione</button>
        <button data-tab="impostazioni">Impostazioni</button>
      </nav>
    </div>
  </div>
</header>

<main>
  <!-- Catalogo -->
  <section id="catalogo" class="tab">
    <div id="banner" class="banner"></div>
    <div class="toolbar">
      <div class="field" style="max-width:200px">
        <label>Anno ≥</label>
        <select id="filterYear">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="all" selected>Tutti</option>
        </select>
      </div>
      <input id="q" type="text" placeholder="Cerca titolo, autore, editore…" style="flex:1;min-width:200px">
      <span id="adminTools" style="display:none;gap:8px">
        <button class="btn right" id="btnExport">Esporta JSON</button>
      </span>
    </div>
    <div id="gridCatalogo" class="grid"></div>
  </section>

  <!-- Nuovo titolo -->
  <section id="nuovo" class="tab" style="display:none">
    <div class="toolbar">
      <div class="small muted">I campi con (*) sono obbligatori.</div>
      <span class="right small muted">Il titolo apparirà in <b>Catalogo</b> dopo l’approvazione di un admin.</span>
    </div>

    <!-- riga 1 -->
    <div class="row">
      <div class="field"><label>Titolo *</label><input id="f_title" type="text" placeholder="Titolo del libro"></div>
      <div class="field"><label>Autore *</label><input id="f_author" type="text" placeholder="Nome Cognome"></div>
      <div class="field"><label>Editore *</label><input id="f_publisher" type="text" placeholder="Casa editrice"></div>
      <div class="field" style="max-width:120px"><label>Anno *</label><input id="f_year" type="number" min="1900" max="2100" value="2025"></div>
      <div class="field" style="max-width:160px"><label>Collana</label><input id="f_series" type="text" placeholder="Collana"></div>
    </div>

    <!-- riga 2 -->
    <div class="row">
      <div class="field" style="max-width:220px"><label>ISBN</label><input id="f_isbn" type="text" placeholder="978-..."></div>
      <div class="field"><label>Store Amazon</label><input id="f_amz" type="url" placeholder="https://amazon.it/..."></div>
      <div class="field"><label>Store editore</label><input id="f_store" type="url" placeholder="https://shop.editore.it/..."></div>
    </div>

    <!-- riga 3 -->
    <div class="row">
      <div class="field">
        <label>URL copertina (JPG/PNG)</label>
        <input id="f_cover" type="url" placeholder="https://.../cover.jpg">
        <div class="hint">Se omesso, verrà mostrato un segnaposto.</div>
      </div>
      <div class="field" style="max-width:200px">
        <label>Romanzo d'esordio?</label>
        <select id="f_debut">
          <option value="unknown" selected>Non specificato</option>
          <option value="yes">Sì</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>

    <!-- riga 4 -->
    <div class="row">
      <div class="field" style="flex:1">
        <label>Sinossi</label>
        <textarea id="f_desc" placeholder="Breve sinossi del libro (facoltativa)"></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnSaveNew">Salva in revisione</button>
      <span class="hint">Il titolo apparirà in Catalogo dopo l’approvazione di un admin.</span>
    </div>
  </section>

  <!-- Notizie (lista) -->
  <section id="notizie" class="tab" style="display:none">
    <div id="newsAdminBar" class="toolbar" style="display:none">
      <div class="field" style="flex:1"><label>Titolo</label><input id="news_title" type="text" placeholder="Titolo della notizia"></div>
      <div class="right"><button id="btnExportNews" class="btn">Esporta news</button></div>
    </div>
    <div id="newsEditor" style="display:none">
      <div class="toolbar" style="margin-bottom:6px">
        <button class="btn small" data-cmd="bold">Grassetto</button>
        <button class="btn small" data-cmd="italic">Corsivo</button>
        <button class="btn small" data-cmd="underline">Sottolineato</button>
        <button class="btn small" data-cmd="ul">Elenco</button>
        <button class="btn small" data-cmd="link">Link</button>
        <button class="btn small" data-cmd="bigger">A+</button>
        <button class="btn small" data-cmd="smaller">A−</button>
        <button class="btn small" data-cmd="clear">Svuota</button>
      </div>
      <div id="news_body_html" contenteditable="true" style="border:1px solid var(--border);border-radius:10px;padding:10px;min-height:160px"></div>
      <div class="actions">
        <button class="btn primary" id="btnSaveNews">Pubblica notizia</button>
        <button class="btn" id="btnCancelEdit" style="display:none">Annulla modifica</button>
        <span class="hint">Solo gli admin possono pubblicare/aggiornare le notizie.</span>
      </div>
    </div>

    <div id="gridNews" class="grid"></div>
  </section>

  <!-- Notizia (articolo) -->
  <section id="newsview" class="tab" style="display:none">
    <div class="news-article">
      <div class="backAppTop"><button class="btn" id="btnBackTop">Torna all’app</button></div>
      <h2 id="articleTitle" style="margin:6px 0 4px 0"></h2>
      <div id="articleMeta" class="news-meta"></div>
      <div id="articleBody"></div>
      <div class="backRow"><button class="btn" id="btnBackBottom">Torna all’app</button></div>
    </div>
  </section>

  <!-- Moderazione -->
  <section id="moderazione" class="tab" style="display:none">
    <div class="toolbar">
      <div class="field" style="max-width:220px">
        <label>Mostra</label>
        <select id="moderationFilter">
          <option value="pending" selected>In revisione</option>
          <option value="approved">Approvati</option>
          <option value="all">Tutti</option>
        </select>
      </div>
    </div>
    <div id="gridModeration" class="grid"></div>
  </section>

  <!-- Impostazioni -->
  <section id="impostazioni" class="tab" style="display:none">
    <h3>Impostazioni sito</h3>
    <div class="small muted" style="margin-bottom:10px">Gli URL remoti consentono di centralizzare credenziali e catalogo.</div>
    <div class="row">
      <div class="field"><label>URL remoto admins.json</label><input id="adminsUrl" type="url" placeholder="https://tuodominio/data/admins.json"></div>
      <div class="field"><label>URL remoto catalogo.json</label><input id="catalogUrl" type="url" placeholder="https://tuodominio/data/catalogo.json"></div>
      <div class="field"><label>URL remoto news.json</label><input id="newsUrl" type="url" placeholder="https://tuodominio/data/news.json"></div>
      <button class="btn" id="btnSaveUrls">Salva URL</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnClearLocal">Svuota cache locale</button>
      <button class="btn" id="btnForceReload">Ricarica dal remoto (sovrascrivi)</button>
    </div>
    <div class="divider"></div>
    <h3>Amministratori</h3>
    <div class="small muted">Login centralizzato con hash PBKDF2 saltato. Puoi generare credenziali con l’utility in <a href="admin-tool.html" target="_blank" rel="noopener">admin-tool</a>.</div>
    <div class="actions" style="margin-top:12px">
      <button class="btn danger" id="btnLogout">Esci dalla sessione admin</button>
    </div>
  </section>
</main>

<footer>
  <div>Fantasy Italia — Nuove proposte è un catalogo collaborativo dedicato alla narrativa fantasy italiana contemporanea.</div>
  <div style="margin-top:6px">
    <a href="legal.html">Note legali & privacy</a><span class="sep">•</span>
    <a href="mailto:simonegrosso.writer@gmail.com">Contatti</a>
  </div>
</footer>

<script>
(function(){
  'use strict';
  const $  = function(s){ return document.querySelector(s); };
  const $$ = function(s){ return Array.from(document.querySelectorAll(s)); };

  /* Logo Amazon (invariato) */
  const AMAZON_IMG_RAW_URL = 'https://raw.githubusercontent.com/S-grosso/Fantasy-Italia-Nuove-Proposte/main/logo_store.png';

  /* === Stato & impostazioni === */
  const state = {
    settings: load('fi_settings_site_v38', { adminsUrl:'', catalogUrl:'', newsUrl:'' }),
    remoteAdmins: null,
    books: load('fi_books_site_v38', []),
    news:  load('fi_news_site_v38', []),
    isAdmin: false,
    meUser: null,
    newsReady: false,
    editingNewsId: null
  };

  const DEFAULT_BASE = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');
  const DEFAULT_ADMINS_URL  = DEFAULT_BASE + 'data/admins.json';
  const DEFAULT_CATALOG_URL = DEFAULT_BASE + 'data/catalogo.json';
  const DEFAULT_NEWS_URL    = DEFAULT_BASE + 'data/news.json';
  if(!state.settings.adminsUrl)  state.settings.adminsUrl  = DEFAULT_ADMINS_URL;
  if(!state.settings.catalogUrl) state.settings.catalogUrl = DEFAULT_CATALOG_URL;
  if(!state.settings.newsUrl)    state.settings.newsUrl    = DEFAULT_NEWS_URL;
  save('fi_settings_site_v38', state.settings);

  /* === Storage helpers === */
  function load(key, fallback){
    try{ var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ return fallback; }
  }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  /* === Cache-busting per evitare vecchie versioni === */
  function withBust(url){
    try{ const u=new URL(url, location.href); u.searchParams.set('v', Date.now().toString()); return u.toString(); }
    catch(_){ return url + (url.includes('?')?'&':'?') + 'v=' + Date.now(); }
  }
  async function fetchJson(url){
    const res = await fetch(withBust(url), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status+' @ '+url);
    return res.json();
  }

  /* === Candidati URL e fetch robusto === */
  function candidates(kind){
    var list = [];
    var setUrl = state.settings[kind+'Url'];
    if(setUrl) list.push(setUrl);
    var names = (kind==='catalog') ? ['data/catalogo.json','catalogo.json']
             : (kind==='news')    ? ['data/news.json','news.json']
                                  : ['data/admins.json','admins.json'];
    names.forEach(function(n){ list.push(n.startsWith('/')? n : ('/'+n)); list.push(n); });
    return Array.from(new Set(list));
  }
  async function tryFetchAny(kind){
    const list=candidates(kind);
    for(const raw of list){
      const url = withBust(raw);
      try{ const j=await fetchJson(url); return {ok:true, url, data:j}; }
      catch(e){ /* silenzio */ }
    }
    return {ok:false};
  }

  /* === Normalizzazione === */
  function normalizeBook(x){
    const b={...x};
    // Per i vecchi JSON che non hanno 'status', consideriamo approvato
    if(b.status==null || b.status==='') b.status='approved';
    if(!Array.isArray(b.labels)) b.labels = b.labels ? [].concat(b.labels) : [];
    b.featured = !!b.featured;
    return b;
  }
  function normalizeNews(arr){
    return (arr||[]).map(function(x,i){
      return { id:x.id||('n'+i), title:x.title, bodyHtml:x.bodyHtml||x.body||'', ts:x.ts||Date.now() };
    });
  }

  /* === Bootstrap iniziale solo se locale vuoto === */
  async function bootstrapIfEmpty(){
    var hasBooks = Array.isArray(state.books) && state.books.length>0;
    var hasNews  = Array.isArray(state.news)  && state.news.length>0;
    if(hasBooks && hasNews) return;
    const bann = $('#banner');
    try{
      const [c,n] = await Promise.all([ tryFetchAny('catalog'), tryFetchAny('news') ]);
      if(c.ok){ state.books=c.data.map(normalizeBook); save('fi_books_site_v38', state.books); }
      if(n.ok){ state.news=normalizeNews(n.data); save('fi_news_site_v38', state.news); }
      if(!c.ok || !n.ok){ bann.innerHTML='⚠️ Non riesco a caricare tutti i dati. Verifica gli URL in <b>Impostazioni</b> o che i file JSON esistano in <code>/data/</code>.'; bann.style.display='block'; }
      renderCatalogo(); renderNews();
    }catch(err){ console.error(err); bann.innerHTML='⚠️ Errore di caricamento dati. Apri <b>Impostazioni</b> e controlla gli URL.'; bann.style.display='block'; }
  }

  /* === Revalidazione: controlla se i remoti sono cambiati e aggiorna la UI === */
  async function revalidateRemotes(){
    try{
      const [c,n] = await Promise.allSettled([ tryFetchAny('catalog'), tryFetchAny('news') ]);
      let changed=false;
      if(c.status==='fulfilled' && c.value.ok){
        const newBooks = (c.value.data||[]).map(normalizeBook);
        if(JSON.stringify(newBooks) !== JSON.stringify(state.books)){
          state.books = newBooks; save('fi_books_site_v38', state.books); changed=true;
        }
      }
      if(n.status==='fulfilled' && n.value.ok){
        const newNews = normalizeNews(c.value ? (n.value.data||[]) : (n.value.data||[])); // safe
        if(JSON.stringify(newNews) !== JSON.stringify(state.news)){
          state.news = newNews; save('fi_news_site_v38', state.news); changed=true;
        }
      }
      if(changed){ renderCatalogo(); renderNews(); }
    }catch(e){ /* ignora: non blocca la pagina */ }
  }

  /* === Admin sessione === */
  function sessionIsValid(){
    const u=sessionStorage.getItem('fi_admin_user');
    const t=+sessionStorage.getItem('fi_admin_time')||0;
    if(!u || (Date.now()-t > 4*60*60*1000)) return false;
    if(Array.isArray(state.remoteAdmins)){
      return state.remoteAdmins.some(function(a){ return a.u===u; });
    }
    return true;
  }
  function touchSession(){ sessionStorage.setItem('fi_admin_time', String(Date.now())); }
  function clearSession(){ sessionStorage.removeItem('fi_admin_user'); sessionStorage.removeItem('fi_admin_time'); }

  async function preloadAdmins(){
    const r = await tryFetchAny('admins');
    if(r.ok){
      state.remoteAdmins = r.data;
      if(!sessionIsValid()){
        clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI();
      }
    }
  }

  async function pbkdf2Hex(pass, saltHex, iters, length=32){
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveBits']);
    const salt = new Uint8Array((saltHex.match(/.{1,2}/g)||[]).map(function(b){return parseInt(b,16);})); 
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations:iters}, key, length*8);
    return Array.from(new Uint8Array(bits)).map(function(x){return x.toString(16).padStart(2,'0');}).join('');
  }
  async function doLoginFlow(){
    const u=prompt('Inserisci username admin'); if(u===null||!u.trim()) return false;
    const pass=prompt('Inserisci password'); if(pass===null) return false;
    try{
      const list = state.remoteAdmins || (await (async function(){ const r=await tryFetchAny('admins'); if(!r.ok) throw new Error('admins.json non trovato'); return r.data; })());
      state.remoteAdmins = list;
      const rec = list.find(function(x){ return x.u===u.trim(); });
      if(!rec){ alert('Utente non trovato.'); return false; }
      const h = await pbkdf2Hex(pass, rec.salt, rec.iter);
      if(h!==rec.hash){ alert('Password errata.'); return false; }
      sessionStorage.setItem('fi_admin_user', rec.u);
      touchSession();
      state.isAdmin=true; state.meUser=rec.u;
      applyAdminUI();
      alert('Accesso admin eseguito.');
      return true;
    }catch(e){
      console.error(e); alert('Errore durante il login.');
      return false;
    }
  }

  var adminToggleEl = $('#adminToggle');
  if(adminToggleEl){
    adminToggleEl.addEventListener('click', async function(){
      if(sessionIsValid()){ clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.'); }
      else await doLoginFlow();
    });
  }

  /* === Impostazioni === */
  var saveUrlsEl = $('#btnSaveUrls');
  if(saveUrlsEl){
    saveUrlsEl.addEventListener('click', function(){
      state.settings.adminsUrl=$('#adminsUrl').value.trim();
      state.settings.catalogUrl=$('#catalogUrl').value.trim();
      state.settings.newsUrl=$('#newsUrl').value.trim();
      save('fi_settings_site_v38', state.settings);
      alert('URL salvati. Ricarica la pagina.');
    });
  }
  var logoutEl = $('#btnLogout');
  if(logoutEl){
    logoutEl.addEventListener('click', function(){
      clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.');
    });
  }
  var clearLocalEl = $('#btnClearLocal');
  if(clearLocalEl){
    clearLocalEl.addEventListener('click', function(){
      localStorage.removeItem('fi_books_site_v38');
      localStorage.removeItem('fi_news_site_v38');
      state.books = [];
      state.news  = [];
      renderCatalogo();
      renderNews();
      alert('Cache locale svuotata. La pagina verrà ricaricata.');
      location.reload();
    });
  }
  var forceReloadEl = $('#btnForceReload');
  if(forceReloadEl){
    forceReloadEl.addEventListener('click', async function(){
      try{
        const c = await tryFetchAny('catalog');
        const n = await tryFetchAny('news');
        if(c.ok){ state.books=c.data.map(normalizeBook); save('fi_books_site_v38', state.books); }
        if(n.ok){ state.news=normalizeNews(n.data); save('fi_news_site_v38', state.news); }
        renderCatalogo(); renderNews();
        alert('Dati ricaricati.');
      }catch(e){ console.error(e); alert('Errore nel caricamento remoto.'); }
    });
  }

  /* === UI Admin privata === */
  function applyAdminUI(){
    const on=sessionIsValid();
    var navAdmin = $('#navAdmin'), adminBadge = $('#adminBadge'), adminToggle = $('#adminToggle'), adminTools = $('#adminTools'), newsAdminBar = $('#newsAdminBar'), newsEditor = $('#newsEditor');
    if(navAdmin) navAdmin.style.display = on ? 'flex' : 'none';
    if(adminBadge){ adminBadge.style.display = on ? 'inline-block' : 'none'; adminBadge.textContent = on ? ('Admin: ' + (sessionStorage.getItem('fi_admin_user')||'')) : ''; }
    if(adminToggle) adminToggle.textContent = on ? 'Esci admin' : 'Accedi admin';
    if(adminTools) adminTools.style.display = on ? 'flex' : 'none';
    if(newsAdminBar) newsAdminBar.style.display = on ? 'flex' : 'none';
    if(newsEditor) newsEditor.style.display = on ? '' : 'none';
  }

  /* === Helpers form === */
  function clearForm(){
    ['f_title','f_author','f_publisher','f_series','f_cover','f_desc','f_amz','f_store','f_isbn'].forEach(function(id){
      var el=$('#'+id); if(el) el.value='';
    });
    var fy=$('#f_year'); if(fy) fy.value=new Date().getFullYear();
    var fd=$('#f_debut'); if(fd) fd.value='unknown';
  }
  function collectForm(){
    const title=($('#f_title').value||'').trim();
    const author=($('#f_author').value||'').trim();
    const publisher=($('#f_publisher').value||'').trim();
    const year=parseInt($('#f_year').value,10);
    if(!title||!author||!publisher||!year){ alert('Compila titolo, autore, editore e anno.'); return null; }
    const series=$('#f_series').value.trim();
    const coverUrl=$('#f_cover').value.trim();
    const description=$('#f_desc').value.trim();
    const storeAmazonUrl=$('#f_amz').value.trim();
    const storePublisherUrl=$('#f_store').value.trim();
    const isbn=$('#f_isbn').value.trim();
    const sel=$('#f_debut').value; const isDebut = (sel==='yes')?true:(sel==='no')?false:null;
    return { id:'b'+Date.now().toString(36), title, author, publisher, year, series, isbn, coverUrl, description, storeAmazonUrl, storePublisherUrl, isDebut, labels:[], status:'pending', featured:false };
  }
  var btnSaveNewEl=$('#btnSaveNew');
  if(btnSaveNewEl){
    btnSaveNewEl.addEventListener('click', function(){
      const b=collectForm(); if(!b) return;
      b.status='pending'; if(!Array.isArray(state.books)) state.books=[];
      state.books.push(b); save('fi_books_site_v38', state.books);
      renderCatalogo(); clearForm(); alert('Titolo salvato in Revisione.');
    });
  }

  /* === Catalogo === */
  function tagEl(text, cls){ if(!cls) cls='tag'; const t=document.createElement('span'); t.className=cls; t.textContent=text; return t; }
  function placeholderCover(){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="160" viewBox="0 0 120 160"><rect width="100%" height="100%" fill="#0b0e13"/><rect x="10" y="10" width="100" height="140" rx="8" ry="8" fill="#0f141d" stroke="#1d2230"/><text x="60" y="83" text-anchor="middle" font-family="ui-sans-serif,system-ui" font-size="14" fill="#5e657a">Copertina</text></svg>');
  }
  function bookCard(b){
    const el=document.createElement('div'); el.className='card';
    if(b.featured){ const bd=document.createElement('div'); bd.className='badge'; bd.textContent='Consigliato'; el.appendChild(bd); }
    const img=document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src=b.coverUrl||placeholderCover();
    const meta=document.createElement('div'); meta.className='meta';
    const h3=document.createElement('h3'); h3.textContent=b.title||'(Senza titolo)';
    const by=document.createElement('div'); by.className='by'; by.textContent=[b.author,b.publisher,b.year].filter(Boolean).join(' • ');
    const desc=document.createElement('div'); desc.className='small muted'; desc.textContent=(b.description||'').length>200? (b.description.slice(0,199)+'…') : (b.description||'');
    const tags=document.createElement('div'); tags.className='tags';
    const debutText = (b.isDebut===true)?'Esordio: sì' : (b.isDebut===false?'Esordio: no':'Esordio: ?');
    tags.appendChild(tagEl(debutText));
    if(Array.isArray(b.labels)) b.labels.slice(0,6).forEach(function(l){ tags.appendChild(tagEl(l,'tag label')); });
    const actions=document.createElement('div'); actions.className='actions';
    const amz=b.storeAmazonUrl||b.storeUrl||'';
    if(amz){
      const btn=document.createElement('a'); btn.href=amz; btn.target='_blank'; btn.rel='noopener'; btn.className='btn-amz'; btn.title='Amazon'; btn.setAttribute('aria-label','Apri su Amazon');
      const imgA=document.createElement('img'); imgA.alt='Amazon'; imgA.loading='lazy'; imgA.src = AMAZON_IMG_RAW_URL;
      btn.appendChild(imgA); actions.appendChild(btn);
    }
    if(b.storePublisherUrl){
      const s=document.createElement('a'); s.href=b.storePublisherUrl; s.target='_blank'; s.rel='noopener'; s.className='btn btn-store'; s.textContent='Store editore';
      actions.appendChild(s);
    }
    meta.appendChild(h3); meta.appendChild(by); meta.appendChild(desc); meta.appendChild(tags); meta.appendChild(actions);
    el.appendChild(img); el.appendChild(meta);
    return el;
  }
  function renderCatalogo(){
    const grid=$('#gridCatalogo'); grid.innerHTML='';
    const q=($('#q').value||'').toLowerCase().trim(); const fy=$('#filterYear').value;
    let list=Array.isArray(state.books)? state.books.slice():[];

    /* <<< FIX: mostra SOLO gli approvati >>> */
    list = list.filter(function(b){ return (b.status||'approved')==='approved'; });

    if(fy!=='all'){ const y=parseInt(fy,10)||0; list=list.filter(function(b){ return (+b.year||0)>=y; }); }
    if(q){ list=list.filter(function(b){ return [b.title,b.author,b.publisher,(b.labels||[]).join(' ')].filter(Boolean).join(' ').toLowerCase().includes(q); }); }
    list.sort(function(a,b){
      const fa=(a.featured?1:0), fb=(b.featured?1:0); if(fa!==fb) return fb-fa;
      const ya=(+a.year||0), yb=(+b.year||0); if(ya!==yb) return yb-ya;
      const ta=(a.title||'').toLocaleLowerCase(), tb=(b.title||'').toLocaleLowerCase(); return ta.localeCompare(tb,'it');
    });
    if(!list.length){ grid.innerHTML='<div class="muted">Nessun titolo.</div>'; return; }
    list.forEach(function(b){ grid.appendChild(bookCard(b)); });
  }
  var fyEl=$('#filterYear'); if(fyEl){ fyEl.addEventListener('change', renderCatalogo); }
  var qEl=$('#q'); if(qEl){ (function(){var t; qEl.addEventListener('input', function(){ clearTimeout(t); t=setTimeout(renderCatalogo,200); });})(); }
  var btnExportEl=$('#btnExport');
  if(btnExportEl){
    btnExportEl.addEventListener('click', function(){
      const blob=new Blob([JSON.stringify(state.books,null,2)], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogo.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  }

  /* === Moderazione === */
  function modCard(b){
    const el = document.createElement('div'); el.className='card'; el.dataset.id = b.id||'';
    const img = document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src=b.coverUrl||placeholderCover();
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent='Consigliato'; if(!b.featured) badge.style.display='none'; el.appendChild(badge);
    const meta = document.createElement('div'); meta.className='meta';
    const h3 = document.createElement('h3'); h3.textContent = b.title || '(Senza titolo)';
    const by = document.createElement('div'); by.className='by'; by.textContent=[b.author,b.publisher,b.year].filter(Boolean).join(' • ');

    const labelsWrap=document.createElement('div'); labelsWrap.className='tags';
    function refreshLabels(){ labelsWrap.innerHTML=''; (b.labels||[]).forEach(function(l){ labelsWrap.appendChild(tagEl(l,'tag label')); }); }
    refreshLabels();

    const addRow = document.createElement('div'); addRow.className='row';
    const addField = document.createElement('input'); addField.type='text'; addField.placeholder='Nuova etichetta'; addField.style.minWidth='200px';
    const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Aggiungi';
    addBtn.addEventListener('click', function(){ const val=(addField.value||'').trim(); if(!val) return; if(!Array.isArray(b.labels)) b.labels=[]; if(!b.labels.includes(val)) b.labels.push(val); addField.value=''; save('fi_books_site_v38', state.books); refreshLabels(); renderCatalogo(); });

    const featLbl = document.createElement('label'); featLbl.className='small muted';
    const featChk = document.createElement('input'); featChk.type='checkbox'; featChk.checked=!!b.featured; featChk.style.marginRight='6px';
    featChk.addEventListener('change', function(){ b.featured=!!featChk.checked; badge.style.display=b.featured?'':'none'; save('fi_books_site_v38', state.books); renderCatalogo(); });
    featLbl.appendChild(featChk); featLbl.appendChild(document.createTextNode(' Consigliato'));

    const debutSel=document.createElement('select');
    ['Non specificato','Sì','No'].forEach(function(t,i){ const o=document.createElement('option'); o.textContent=t; o.value=['unknown','yes','no'][i]; debutSel.appendChild(o); });
    debutSel.value = (b.isDebut===true?'yes':b.isDebut===false?'no':'unknown');
    debutSel.addEventListener('change', function(){ const v=debutSel.value; b.isDebut = (v==='yes'?true:(v==='no'?false:null)); save('fi_books_site_v38', state.books); renderCatalogo(); });

    const actions = document.createElement('div'); actions.className='actions';
    const approve = document.createElement('button'); approve.className='btn primary'; approve.textContent = (b.status==='approved') ? 'Revoca approvazione' : 'Approva';
    approve.addEventListener('click', function(){ b.status = (b.status==='approved') ? 'pending' : 'approved'; approve.textContent = (b.status==='approved') ? 'Revoca approvazione' : 'Approva'; save('fi_books_site_v38', state.books); renderModeration(); renderCatalogo(); });

    const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Salva';
    saveBtn.addEventListener('click', function(){ save('fi_books_site_v38', state.books); renderModeration(); renderCatalogo(); alert('Modifiche salvate.'); });

    addRow.appendChild(addField); addRow.appendChild(addBtn);
    meta.appendChild(h3); meta.appendChild(by);
    meta.appendChild(labelsWrap); meta.appendChild(addRow);
    meta.appendChild(featLbl);
    const debutWrap=document.createElement('div'); debutWrap.className='small'; debutWrap.style.marginTop='6px'; debutWrap.append(' Esordio: ', debutSel);
    meta.appendChild(debutWrap);
    meta.appendChild(actions); actions.appendChild(approve); actions.appendChild(saveBtn);

    el.appendChild(img); el.appendChild(meta);
    return el;
  }
  function renderModeration(){
    const grid = $('#gridModeration'); if(!grid) return;
    const f = $('#moderationFilter').value;
    let list = Array.isArray(state.books) ? state.books.slice() : [];
    if(f==='pending')  list = list.filter(function(b){ return b.status!=='approved'; });
    if(f==='approved') list = list.filter(function(b){ return b.status==='approved'; });
    grid.innerHTML='';
    if(!list.length){ grid.innerHTML='<div class="muted">Nessun titolo.</div>'; return; }
    list.forEach(function(b){ grid.appendChild(modCard(b)); });
  }
  var modFilterEl=$('#moderationFilter');
  if(modFilterEl){ modFilterEl.addEventListener('change', renderModeration); }

  /* === Notizie === */
  function sanitizeHtml(html){ return html.replace(/<script/gi,'&lt;script'); }

  function startEditNews(item){
    $('#news_title').value = item.title||'';
    $('#news_body_html').innerHTML = item.bodyHtml||'';
    state.editingNewsId = item.id;
    $('#btnSaveNews').textContent = 'Aggiorna notizia';
    var cancelEl=$('#btnCancelEdit'); if(cancelEl) cancelEl.style.display = 'inline-flex';
    showTab('notizie');
  }

  function deleteNews(id){
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    if(!confirm('Eliminare definitivamente questa notizia?')) return;
    state.news = (state.news||[]).filter(function(n){ return String(n.id)!==String(id); });
    save('fi_news_site_v38', state.news);
    if((location.hash||'').indexOf('#news/'+id)===0) location.hash='#notizie';
    renderNews();
  }

  function renderNews(){
    const grid=$('#gridNews'); grid.innerHTML='';
    const list=(state.news||[]).slice().sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
    list.forEach(function(n){
      const card=document.createElement('div'); card.className='news-card'; card.tabIndex=0;
      card.addEventListener('click', function(){ location.hash='#news/'+(n.id||''); });
      card.addEventListener('keydown', function(e){ if(e.key==='Enter') card.click(); });

      const h3=document.createElement('h3'); h3.textContent=n.title||'(Senza titolo)';
      const body=document.createElement('div'); body.className='muted line-clamp';
      const text = (n.bodyHtml||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      body.textContent = text.length>280 ? text.slice(0,280)+'…' : text;

      card.appendChild(h3); card.appendChild(body);

      if(sessionIsValid()){
        const adminBar=document.createElement('div'); adminBar.className='news-admin-actions';
        const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.textContent='Modifica';
        const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.textContent='Elimina';
        editBtn.addEventListener('click', function(ev){ ev.stopPropagation(); startEditNews(n); });
        delBtn.addEventListener('click', function(ev){ ev.stopPropagation(); deleteNews(n.id); });
        adminBar.appendChild(editBtn); adminBar.appendChild(delBtn);
        card.appendChild(adminBar);
      }

      grid.appendChild(card);
    });
    state.newsReady=true;
  }

  $$('#newsEditor [data-cmd]').forEach(function(btn){
    btn.addEventListener('click', function(){
      const cmd=btn.getAttribute('data-cmd'); const ed=$('#news_body_html'); ed.focus();
      if(cmd==='bold') document.execCommand('bold', false, null);
      else if(cmd==='italic') document.execCommand('italic', false, null);
      else if(cmd==='underline') document.execCommand('underline', false, null);
      else if(cmd==='ul') document.execCommand('insertUnorderedList', false, null);
      else if(cmd==='link'){ const url=prompt('Inserisci URL (https://...)'); if(url && /^https?:/i.test(url)) document.execCommand('createLink', false, url); }
      else if(cmd==='bigger' || cmd==='smaller'){ const sel=window.getSelection(); if(!sel.rangeCount) return; const range=sel.getRangeAt(0); const span=document.createElement('span'); span.style.fontSize=(cmd==='bigger'?'1.15em':'0.9em'); range.surroundContents(span); }
      else if(cmd==='clear'){ ed.innerHTML=''; }
    });
  });

  (function hookSave(){
    const btn=$('#btnSaveNews'); if(!btn) return;
    btn.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      if(!sessionIsValid(){ alert('Solo admin.'); return; }  // <- evita pubblicazioni non admin
      const title=($('#news_title').value||'').trim();
      const html=sanitizeHtml($('#news_body_html').innerHTML||'');
      if(!title){ alert('Titolo obbligatorio.'); return; }
      if(!html){ alert('Inserisci un testo.'); return; }

      if(state.editingNewsId){
        const idx=(state.news||[]).findIndex(function(n){ return String(n.id)===String(state.editingNewsId); });
        if(idx>=0){ state.news[idx].title=title; state.news[idx].bodyHtml=html; state.news[idx].ts=Date.now(); }
        state.editingNewsId=null;
        $('#btnSaveNews').textContent='Pubblica notizia';
        var cancelEl=$('#btnCancelEdit'); if(cancelEl) cancelEl.style.display='none';
        alert('Notizia aggiornata.');
      }else{
        const item={ id:'n'+Date.now().toString(36), title, bodyHtml:html, ts:Date.now() };
        if(!Array.isArray(state.news)) state.news=[];
        state.news.push(item);
        alert('Notizia pubblicata.');
      }
      save('fi_news_site_v38', state.news);
      $('#news_title').value=''; $('#news_body_html').innerHTML='';
      renderNews();
    }, true);
  })();

  var cancelEditEl=$('#btnCancelEdit');
  if(cancelEditEl){
    cancelEditEl.addEventListener('click', function(){
      state.editingNewsId=null;
      $('#btnSaveNews').textContent='Pubblica notizia';
      cancelEditEl.style.display='none';
      $('#news_title').value=''; $('#news_body_html').innerHTML='';
    });
  }

  var exportNewsEl=$('#btnExportNews');
  if(exportNewsEl){
    exportNewsEl.addEventListener('click', function(){
      const blob=new Blob([JSON.stringify(state.news,null,2)], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='news.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  }

  /* ------- Routing & Deep Link ------- */

  function showTab(tab){
    $$('.tab').forEach(function(s){ s.style.display='none'; });
    const el=$('#'+tab); if(el) el.style.display='';
    $$('#navPublic button, #navAdmin button').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tab')===tab); });
  }

  function openNewsById(id){
    const item = (state.news||[]).find(function(n){ return String(n.id)===String(id); });
    if(!item){ return false; }
    $('#articleTitle').textContent = item.title || '';
    $('#articleMeta').textContent = new Date(item.ts||Date.now()).toLocaleString('it-IT');
    $('#articleBody').innerHTML = item.bodyHtml || '';
    showTab('newsview');

    /* Aggiorna URL con fallback compatibile ai social: ?n=<id>#news/<id> */
    var safeId = encodeURIComponent(String(id));
    var newUrl = location.pathname + '?n='+ safeId + '#news/' + safeId;
    if(location.search !== ('?n='+safeId) || location.hash !== ('#news/'+safeId)){
      history.replaceState(null, '', newUrl);
    }
    return true;
  }

  /* Pulsanti Torna all’app */
  function backToNews(e){
    if(e && e.preventDefault) e.preventDefault();
    history.pushState(null, '', location.pathname + '#notizie');
    showTab('notizie');
  }
  var backTop = $('#btnBackTop');
  if(backTop) backTop.addEventListener('click', backToNews);
  var backBottom = $('#btnBackBottom');
  if(backBottom) backBottom.addEventListener('click', backToNews);

  /* Se un social toglie il #, uso la query (?n= / ?news=) per ripristinare il deep link */
  function applyDeepLinkFromQuery(){
    if(location.hash && location.hash.length>1) return; // già con hash
    var p = new URLSearchParams(location.search);
    var id = p.get('n') || p.get('news');
    if(id){
      var safeId = encodeURIComponent(String(id));
      history.replaceState(null, '', location.pathname + '?n='+safeId + '#news/' + safeId);
    }
  }

  async function ensureNewsLoaded(){
    if((state.news||[]).length>0) return;
    const n = await tryFetchAny('news');
    if(n.ok){
      state.news = normalizeNews(n.data);
      save('fi_news_site_v38', state.news);
      renderNews();
    }
  }

  async function handleRoute(){
    const hash=(location.hash||'').replace(/^#/, '');
    if(hash.indexOf('news/')===0){
      const id = decodeURIComponent(hash.slice(5));
      if(!openNewsById(id)){
        await ensureNewsLoaded();
        if(!openNewsById(id)){
          alert('Articolo non trovato.');
          showTab('notizie');
        }
      }
      return;
    }
    if(hash==='notizie'){ renderNews(); showTab('notizie'); }
    else if(hash==='nuovo'){ showTab('nuovo'); }
    else if(hash==='moderazione'){ renderModeration(); showTab('moderazione'); }
    else if(hash==='impostazioni'){ showTab('impostazioni'); }
    else { showTab('catalogo'); }
  }
  window.addEventListener('hashchange', function(){ handleRoute(); });

  /* Hook nav buttons */
  $$('#navPublic button, #navAdmin button').forEach(function(btn){
    btn.addEventListener('click', function(){
      const tab=btn.getAttribute('data-tab');
      if(tab==='moderazione' || tab==='impostazioni'){
        if(!sessionIsValid()){ alert('Area riservata: accedi come admin.'); return; }
        touchSession();
      }
      if(tab==='moderazione') renderModeration();
      if(tab==='notizie') renderNews();
      showTab(tab);
      if(['catalogo','nuovo','notizie','moderazione','impostazioni'].indexOf(tab)>=0) location.hash = '#'+tab;
    });
  });

  /* Init */
  (async function init(){
    preloadAdmins();
    if(sessionIsValid()){ touchSession(); state.isAdmin=true; state.meUser=sessionStorage.getItem('fi_admin_user'); }
    applyAdminUI();

    // Render immediato da locale
    renderCatalogo();
    renderNews();

    // Se locale è vuoto, bootstrap dal remoto
    await bootstrapIfEmpty();

    // Revalidazione dal remoto anche se il locale NON è vuoto (mostra gli aggiornamenti dei JSON)
    revalidateRemotes();

    /* Prima di gestire la route, applico il fallback da query (?n=/ ?news=) */
    applyDeepLinkFromQuery();
    await handleRoute();
  })();

})();
</script>
</body>
</html>
