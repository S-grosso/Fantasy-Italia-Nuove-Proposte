<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fantasy Italia — Nuove proposte</title>
<meta name="theme-color" content="#7aa6ff">
<style>
  :root{
    --bg:#0f1013; --panel:#171923; --ink:#e7e9ee; --muted:#a9adbb;
    --accent:#7aa6ff; --danger:#ff6b6b; --border:#232635;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,Noto Sans;background:linear-gradient(180deg,#0f1013,#0d0e12 140vh);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:rgba(13,14,18,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0;letter-spacing:.2px;flex:1}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:#151826;color:var(--ink);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  nav button.active{outline:2px solid var(--accent)}
  .adminBadge{font-size:12px;border:1px solid var(--border);padding:6px 9px;border-radius:999px;color:#cfe;opacity:.9}
  .adminToggle{background:#132033;border:1px solid var(--border);color:#dfe;padding:8px 12px;border-radius:10px;cursor:pointer}
  main{padding:20px 16px}
  section{max-width:1100px;margin:0 auto;background:#171923;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{position:relative;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start;min-height:140px}
  .badge{position:absolute;top:8px;left:8px;background:#0f2;color:#072;font-weight:700;font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid #063}
  img.cover{display:block;border-radius:8px;border:1px solid var(--border);max-height:16.6vh;width:auto;object-fit:cover;background:#080a0f}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0 0 6px 0;font-size:16px;line-height:1.2}
  .meta .by{color:var(--muted);font-size:13px;margin-bottom:6px}
  .meta .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:12px;padding:4px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .tag.label{color:#9fc8ff;border-color:#2854aa}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{background:#151826;border:1px solid var(--border);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
  .btn.primary{outline:2px solid var(--accent)}
  .btn.danger{outline:1px solid #402;color:#ff9aa9}
  .btn-amz, .btn-store{width:100px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;background:#131a22;box-shadow:0 1px 2px rgba(0,0,0,.35);border:1px solid #0c0e14;border-radius:10px;font-size:12px;font-weight:600;letter-spacing:.2px}
  .btn-amz img{display:block;max-height:80%;max-width:90%;object-fit:contain}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:180px}
  .field label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="url"], input[type="number"], textarea, select{background:#0f1119;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  textarea{height:90px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  footer{color:var(--muted);font-size:12px;padding:16px;text-align:center}
  footer a{color:#9fc8ff;text-decoration:none}
  footer .sep{opacity:.4;margin:0 8px}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .banner{background:#142036;border:1px solid #223a66;color:#cfe;border-radius:12px;padding:8px 12px;margin:8px 0}

  /* --- Notizie: cards, clamp & overlay --- */
  .news-card{position:relative;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;cursor:pointer}
  .news-card h4{margin:0 0 4px;font-size:16px;line-height:1.2}
  .news-preview{color:var(--muted);font-size:13px;line-height:1.5;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:4;overflow:hidden;white-space:normal;max-height:6.2em}
  .news-toolbar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .news-toolbar .mini{background:#151826;border:1px solid var(--border);color:var(--ink);padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px}
  .editable{background:#0f1119;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px;min-height:140px;line-height:1.5}
  .editable:focus{outline:2px solid #24365e}
  .news-body .bigger{font-size:1.15em}
  .news-body .smaller{font-size:0.9em}
  #newsOverlay{position:fixed;inset:0;background:rgba(10,12,18,.92);backdrop-filter:blur(6px);z-index:50;display:none}
  #newsOverlay .inner{max-width:900px;margin:5vh auto;background:#171923;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #newsOverlay h3{margin:0 0 8px}
  #newsOverlay .news-body{color:var(--ink);font-size:15px;line-height:1.6}
  #btnBackToNews{background:#151826;border:1px solid var(--border);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Fantasy Italia — Nuove proposte</h1>
    <span id="adminBadge" class="adminBadge" style="display:none"></span>
    <button id="adminToggle" class="adminToggle" title="Accedi/Esci come admin">Accedi admin</button>
  </div>
  <div class="wrap" style="padding-top:0">
    <nav id="navPublic">
      <button data-tab="catalogo" class="active">Catalogo</button>
      <button data-tab="nuovo">Nuovo titolo</button>
      <button data-tab="notizie">Notizie</button>
    </nav>
    <nav id="navAdmin" style="display:none">
      <button data-tab="moderazione">Moderazione</button>
      <button data-tab="impostazioni">Impostazioni</button>
    </nav>
  </div>
</header>

<main>
  <!-- Catalogo -->
  <section id="catalogo" class="tab">
    <div id="banner" class="banner" style="display:none"></div>
    <div class="toolbar">
      <div class="field" style="max-width:200px">
        <label>Anno ≥</label>
        <select id="filterYear">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="all" selected>Tutti</option>
        </select>
      </div>
      <input id="q" type="text" placeholder="Cerca titolo, autore, editore…" style="flex:1;min-width:200px">
      <span id="adminTools" style="display:none;gap:8px">
        <button class="btn right" id="btnExport">Esporta JSON</button>
      </span>
    </div>
    <div id="gridCatalogo" class="grid"></div>
  </section>

  <!-- Nuovo titolo -->
  <section id="nuovo" class="tab" style="display:none">
    <div class="row">
      <div class="field"><label>Titolo</label><input id="f_title" type="text"></div>
      <div class="field"><label>Autore</label><input id="f_author" type="text"></div>
      <div class="field"><label>Anno</label><input id="f_year" type="number" min="1900" max="2100" value="2025"></div>
    </div>
    <div class="row">
      <div class="field"><label>Editore</label><input id="f_publisher" type="text"></div>
      <div class="field"><label>ISBN</label><input id="f_isbn" type="text" placeholder="es. 978."></div>
      <div class="field"><label>Link store Amazon</label><input id="f_store_amz" type="url" placeholder="https://amazon."></div>
    </div>
    <div class="row">
      <div class="field"><label>Link store Editore</label><input id="f_store_pub" type="url" placeholder="https://."></div>
      <div class="field"><label>URL copertina</label><input id="f_cover" type="url" placeholder="https://."></div>
      <div class="field"><label>Esordio (nel fantasy)</label>
        <select id="f_debut">
          <option value="unknown" selected>Da verificare</option>
          <option value="yes">Sì</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Descrizione (sinossi)</label>
      <textarea id="f_desc"></textarea>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnSaveNew">Salva (in revisione)</button>
      <span class="hint">I contenuti inviati dagli utenti restano in “Revisione” finché non li approva un admin.</span>
    </div>
  </section>

  <!-- Notizie -->
  <section id="notizie" class="tab" style="display:none">
    <div class="toolbar">
      <div class="muted small">Aggiornamenti e segnalazioni dal catalogo.</div>
      <span id="newsAdminBar" style="display:none; margin-left:auto; gap:8px">
        <button class="btn" id="btnExportNews">Esporta news (JSON)</button>
      </span>
    </div>

    <div id="newsEditor" class="banner" style="display:none">
      <div class="row">
        <div class="field"><label>Titolo notizia</label><input id="news_title" type="text"></div>
      </div>
      <div class="field">
        <label>Contenuto (formattato)</label>
        <div class="news-toolbar">
          <button type="button" class="mini" data-cmd="bold"><b>B</b></button>
          <button type="button" class="mini" data-cmd="italic"><i>I</i></button>
          <button type="button" class="mini" data-cmd="underline"><u>U</u></button>
          <button type="button" class="mini" data-cmd="bigger">A+</button>
          <button type="button" class="mini" data-cmd="smaller">A−</button>
          <button type="button" class="mini" data-cmd="ul">• Lista</button>
          <button type="button" class="mini" data-cmd="link">🔗 Link</button>
          <button type="button" class="mini" data-cmd="clear">✖︎ Pulisci</button>
        </div>
        <div id="news_body_html" class="editable" contenteditable="true" spellcheck="true"></div>
        <div class="hint">L’anteprima della card è generata automaticamente dalle prime righe del testo.</div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnSaveNews">Pubblica notizia</button>
        <span class="hint">Solo gli admin possono pubblicare/aggiornare le notizie.</span>
      </div>
    </div>

    <div id="gridNews" class="grid"></div>
  </section>

  <!-- Moderazione -->
  <section id="moderazione" class="tab" style="display:none">
    <div class="toolbar">
      <div class="field" style="max-width:220px">
        <label>Mostra</label>
        <select id="moderationFilter">
          <option value="pending" selected>In revisione</option>
          <option value="approved">Approvati</option>
          <option value="all">Tutti</option>
        </select>
      </div>
    </div>
    <div id="gridModeration" class="grid"></div>
  </section>

  <!-- Impostazioni -->
  <section id="impostazioni" class="tab" style="display:none">
    <h3>Impostazioni sito</h3>
    <div class="small muted" style="margin-bottom:10px">Gli URL remoti consentono di centralizzare credenziali e catalogo.</div>
    <div class="row">
      <div class="field">
        <label>URL remoto admins.json</label>
        <input id="adminsUrl" type="url" placeholder="https://tuodominio/data/admins.json">
      </div>
      <div class="field">
        <label>URL remoto catalogo.json</label>
        <input id="catalogUrl" type="url" placeholder="https://tuodominio/data/catalogo.json">
      </div>
      <button class="btn" id="btnSaveUrls">Salva URL</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnClearLocal">Svuota cache locale</button>
      <button class="btn" id="btnForceReload">Ricarica dal remoto (sovrascrivi)</button>
    </div>
    <div class="divider"></div>
    <h3>Amministratori</h3>
    <div class="small muted">Login centralizzato con hash PBKDF2 da <a href="admin-tool.html" target="_blank" rel="noopener">admin-tool</a>.</div>
    <div class="actions" style="margin-top:12px">
      <button class="btn danger" id="btnLogout">Esci dalla sessione admin</button>
    </div>
  </section>

  <!-- Overlay Notizia -->
  <div id="newsOverlay">
    <div class="inner">
      <button id="btnBackToNews">◀︎ Torna all’app</button>
      <h3 id="newsFullTitle" style="margin-top:10px"></h3>
      <div id="newsFullBody" class="news-body"></div>
    </div>
  </div>
</main>

<footer>
  <div>Fantasy Italia — Nuove proposte è un catalogo collaborativo dedicato alla narrativa fantasy italiana contemporanea.</div>
  <div style="margin-top:6px">
    <a href="legal.html">Note legali & privacy</a><span class="sep">•</span>
    <a href="mailto:simonegrosso.writer@gmail.com">Contatti</a>
  </div>
  <div id="buildBadgeFoot" class="small muted" style="margin-top:10px"></div>
  <!-- Le voci richieste sono state rimosse. Manteniamo solo la build corrente: -->
  <div class="small muted" style="margin-top:6px;text-align:center">v3.8.4-news-clean • 2025-08-13</div>
</footer>

<script>
(function(){
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const BUILD = 'v3.8.4-news-clean';

  // --- Chiavi & default ---
  const DEFAULT_ADMINS_URL  = location.origin + location.pathname.replace(/\/[^\/]*$/, '/') + 'data/admins.json?v=20250813';
  const DEFAULT_CATALOG_URL = location.origin + location.pathname.replace(/\/[^\/]*$/, '/') + 'data/catalogo.json?v=20250813';
  const DEFAULT_NEWS_URL    = location.origin + location.pathname.replace(/\/[^\/]*$/, '/') + 'data/news.json?v=20250813';

  const state = {
    books: loadBooks(),
    nextId: Date.now(),
    settings: loadSettings(),
    isAdmin: false,
    meUser: null,
    remoteAdmins: [],
    news: loadNews()
  };

  // --- Storage ---
  function loadSettings(){ try{ return JSON.parse(localStorage.getItem('fi_settings_site_v38')||'{}'); }catch(e){ return {}; } }
  function saveSettings(){ localStorage.setItem('fi_settings_site_v38', JSON.stringify(state.settings)); }
  function loadBooks(){ try{ return JSON.parse(localStorage.getItem('fi_books_site_v38')||'[]'); }catch(e){ return []; } }
  function saveBooks(){ localStorage.setItem('fi_books_site_v38', JSON.stringify(state.books)); }
  function loadNews(){ try{ return JSON.parse(localStorage.getItem('fi_news_site_v38')||'[]'); }catch(e){ return []; } }
  function saveNews(){ localStorage.setItem('fi_news_site_v38', JSON.stringify(state.news)); }

  if(!state.settings.adminsUrl)  state.settings.adminsUrl  = DEFAULT_ADMINS_URL;
  if(!state.settings.catalogUrl) state.settings.catalogUrl = DEFAULT_CATALOG_URL;
  if(!state.settings.newsUrl)    state.settings.newsUrl    = DEFAULT_NEWS_URL;
  saveSettings();

  // --- Utils ---
  function showBanner(msg){ const b = $('#banner'); if(!b) return; b.textContent = msg; b.style.display=''; setTimeout(()=>{b.style.display='none';}, 4000); }
  function truncate(s, n){ return (s && s.length>n) ? (s.slice(0,n-1)+'…') : (s||''); }
  async function fetchJson(url){ const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json(); }

  // --- Admin session ---
  function sessionIsValid(){
    const u = sessionStorage.getItem('fi_admin_user');
    const t = parseInt(sessionStorage.getItem('fi_admin_time')||'0',10);
    if(!u || !t) return false;
    if(Date.now() - t > 30*60*1000) return false;
    return (state.remoteAdmins||[]).some(a=>a.u===u);
  }
  function touchSession(){ sessionStorage.setItem('fi_admin_time', String(Date.now())); }
  function clearSession(){ sessionStorage.removeItem('fi_admin_user'); sessionStorage.removeItem('fi_admin_time'); }
  async function pbkdf2Hex(pass, saltHex, iters, length=32){
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveBits']);
    const salt = new Uint8Array(saltHex.match(/.{1,2}/g).map(b=>parseInt(b,16)));
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations:iters}, key, length*8);
    return [...new Uint8Array(bits)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  async function doLoginFlow(){
    const u = prompt('Inserisci username admin'); if(u===null || !u.trim()) return false;
    const p = prompt('Inserisci password admin'); if(p===null) return false;
    const rec = (state.remoteAdmins||[]).find(a => a.u===u);
    if(!rec){ alert('Credenziali non valide.'); return false; }
    const h = await pbkdf2Hex(p, rec.salt, rec.iter||120000, 32);
    if(h !== rec.hash){ alert('Credenziali non valide.'); return false; }
    state.isAdmin = true; state.meUser = u;
    sessionStorage.setItem('fi_admin_user', u);
    touchSession();
    applyAdminUI();
    return true;
  }

  // --- Impostazioni iniziali ---
  (async function syncCatalogOnStartup(){
    try{
      const data = await fetchJson(state.settings.catalogUrl);
      if(Array.isArray(data)){
        // merge minimo non distruttivo
        for(const r of data){ if(!state.books.find(b => ((b.isbn||'')&&(r.isbn||'')&&(b.isbn===r.isbn)))) state.books.push(r); }
        saveBooks();
      }
    }catch(e){ console.warn('Catalog remote load failed:', e); }
    renderCatalogo();
  })();

  (async function loadRemoteAdmins(){
    try{ const data = await fetchJson(state.settings.adminsUrl); if(Array.isArray(data)) state.remoteAdmins = data; }
    catch(e){ console.warn('Admins remote load failed:', e); }
    if(sessionIsValid()){ state.isAdmin=true; state.meUser=sessionStorage.getItem('fi_admin_user'); applyAdminUI(); touchSession(); }
  })();

  (async function syncNewsOnStartup(){
    try{
      const data = await fetchJson(state.settings.newsUrl);
      if(Array.isArray(data) && data.length){ state.news = data; saveNews(); }
    }catch(e){ /* opzionale */ }
  })();

  // --- UI wiring ---
  function applyAdminUI(){
    const on = sessionIsValid();
    $('#navAdmin').style.display = on ? '' : 'none';
    $('#adminBadge').style.display = on ? '' : 'none';
    $('#adminBadge').textContent = on ? ('Admin: '+(state.meUser||'')) : '';
    $('#adminToggle').textContent = on ? 'Esci admin' : 'Accedi admin';
    $('#adminTools').style.display = on ? 'flex' : 'none';
    $('#newsAdminBar').style.display = on ? 'flex' : 'none';
    $('#newsEditor').style.display = on ? '' : 'none';
  }

  // Tabs
  $$('#navPublic button, #navAdmin button').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      if(tab==='moderazione' || tab==='impostazioni'){
        if(!sessionIsValid()){ state.isAdmin=false; state.meUser=null; clearSession(); applyAdminUI(); alert('Area riservata: accedi come admin.'); return; }
        touchSession();
      }
      $$('.tab').forEach(s => s.style.display='none');
      $('#'+tab).style.display='';
      $$('#navPublic button, #navAdmin button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      if(tab==='moderazione') renderModeration();
      if(tab==='impostazioni') renderSettings();
      if(tab==='notizie') renderNews();
    });
  });

  // Admin toggle
  $('#adminToggle').addEventListener('click', async () => {
    if(state.isAdmin){ state.isAdmin=false; state.meUser=null; clearSession(); applyAdminUI(); return; }
    await doLoginFlow();
  });

  // Impostazioni
  function renderSettings(){
    $('#adminsUrl').value  = state.settings.adminsUrl  || DEFAULT_ADMINS_URL;
    $('#catalogUrl').value = state.settings.catalogUrl || DEFAULT_CATALOG_URL;
  }
  $('#btnSaveUrls').addEventListener('click', ()=>{
    state.settings.adminsUrl  = $('#adminsUrl').value.trim()  || DEFAULT_ADMINS_URL;
    state.settings.catalogUrl = $('#catalogUrl').value.trim() || DEFAULT_CATALOG_URL;
    saveSettings();
    alert('URL salvati. Ricarica la pagina per ricaricare le sorgenti remote.');
  });
  $('#btnLogout').addEventListener('click', ()=>{ clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.'); });

  // Cache tools (solo catalogo per semplicità)
  $('#btnClearLocal').addEventListener('click', ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    if(confirm('Svuotare la cache locale (catalogo, notizie e sessione)?')){
      const keep = localStorage.getItem('fi_settings_site_v38');
      localStorage.clear();
      if(keep) localStorage.setItem('fi_settings_site_v38', keep);
      sessionStorage.clear();
      alert('Cache locale svuotata. Ricarica la pagina.');
    }
  });
  $('#btnForceReload').addEventListener('click', async ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    if(!confirm('Sovrascrivere il catalogo locale con la versione remota?')) return;
    try{
      const data = await fetchJson(state.settings.catalogUrl);
      if(!Array.isArray(data)) throw new Error('catalogo.json non è un array');
      state.books = data;
      saveBooks();
      renderCatalogo();
      alert('Catalogo ricaricato dal remoto.');
    }catch(e){ alert('Errore ricarica: '+(e && e.message ? e.message : e)); }
  });

  // Nuovo titolo
  function collectForm(){
    return {
      title: $('#f_title').value.trim(),
      author: $('#f_author').value.trim(),
      year: parseInt($('#f_year').value||'0',10),
      publisher: $('#f_publisher').value.trim(),
      isbn: $('#f_isbn').value.trim(),
      storeAmazonUrl: $('#f_store_amz').value.trim(),
      storePublisherUrl: $('#f_store_pub').value.trim(),
      coverUrl: $('#f_cover').value.trim(),
      description: $('#f_desc').value.trim(),
      isDebut: (function(){ const v=$('#f_debut').value; if(v==='yes') return true; if(v==='no') return false; return null; })(),
      status: 'pending',
      labels: [],
      featured: false
    };
  }
  function clearForm(){
    ['f_title','f_author','f_publisher','f_isbn','f_store_amz','f_store_pub','f_cover','f_desc'].forEach(id=> $('#'+id).value='');
    $('#f_year').value = new Date().getFullYear(); $('#f_debut').value = 'unknown';
  }
  $('#btnSaveNew').addEventListener('click', () => {
    const b = collectForm();
    if(!b.title || !b.author){ alert('Titolo e Autore sono obbligatori.'); return; }
    b.id = 'b'+(state.nextId++); state.books.push(b); saveBooks(); renderCatalogo(); clearForm(); alert('Titolo salvato in Revisione.');
  });

  // Catalogo
  function tagEl(text, cls='tag'){ const t=document.createElement('span'); t.className=cls; t.textContent=text; return t; }
  function placeholderCover(){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="240" height="360"><rect width="100%" height="100%" fill="#0a0c12"/><rect x="1" y="1" width="238" height="358" fill="none" stroke="#232635"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="14" fill="#5e657a">Copertina</text></svg>`);
  }
  function bookCard(b, opts){
    const el = document.createElement('div'); el.className='card';
    if(b.featured){ const bd=document.createElement('div'); bd.className='badge'; bd.textContent='Consigliato'; el.appendChild(bd); }
    const img = document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src = b.coverUrl || placeholderCover();
    const meta = document.createElement('div'); meta.className='meta';
    const h3 = document.createElement('h3'); h3.textContent = b.title || '(Senza titolo)';
    const by = document.createElement('div'); by.className='by'; by.textContent = [b.author, b.publisher, b.year].filter(Boolean).join(' • ');
    const desc = document.createElement('div'); desc.className='small muted'; desc.textContent = b.description ? truncate(b.description, 200) : '';
    const tags = document.createElement('div'); tags.className='tags';
    const db = tagEl((b.isDebut===true)?'Esordio: sì' : (b.isDebut===false?'Esordio: no':'Esordio: ?'));
    tags.appendChild(db);
    if(Array.isArray(b.labels)){ b.labels.slice(0,6).forEach(l => tags.appendChild(tagEl(l, 'tag label'))); }
    const actions = document.createElement('div'); actions.className='actions';

    const amz = b.storeAmazonUrl || b.storeUrl || '';
    if(amz){ const btn=document.createElement('a'); btn.href=amz; btn.target='_blank'; btn.rel='noopener'; btn.className='btn-amz'; btn.title='Amazon';
      const imgA=document.createElement('img'); imgA.alt='Amazon'; imgA.src='https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg'; btn.appendChild(imgA); actions.appendChild(btn); }
    if(b.storePublisherUrl){ const s=document.createElement('a'); s.href=b.storePublisherUrl; s.target='_blank'; s.rel='noopener'; s.className='btn btn-store'; s.textContent='Store editore'; actions.appendChild(s); }

    meta.appendChild(h3); meta.appendChild(by); meta.appendChild(desc); meta.appendChild(tags); meta.appendChild(actions);
    el.appendChild(img); el.appendChild(meta);
    return el;
  }
  function renderCatalogo(){
    const grid = $('#gridCatalogo'); grid.innerHTML='';
    const q = $('#q').value.toLowerCase().trim();
    const fy = $('#filterYear').value;
    let list = [...state.books];
    if(fy!=='all'){ const y = parseInt(fy,10); list = list.filter(b => (parseInt(b.year,10)||0) >= y); }
    if(q){ list = list.filter(b => (b.title||'').toLowerCase().includes(q) || (b.author||'').toLowerCase().includes(q) || (b.publisher||'').toLowerCase().includes(q)); }
    if(!list.length){ grid.innerHTML = '<div class="muted">Nessun risultato. Il catalogo viene caricato dal server all’avvio.</div>'; return; }
    list.sort((a,b)=>{
      if(!!b.featured !== !!a.featured) return (b.featured?1:0) - (a.featured?1:0);
      const ya = parseInt(a.year,10)||0; const yb = parseInt(b.year,10)||0;
      if(yb!==ya) return yb - ya;
      const ta = (a.title||'').toLocaleLowerCase(); const tb = (b.title||'').toLocaleLowerCase();
      return ta.localeCompare(tb,'it');
    });
    for(const b of list){ grid.appendChild(bookCard(b)); }
  }
  $('#filterYear').addEventListener('change', renderCatalogo);
  $('#q').addEventListener('input', (function(){let t; return ()=>{ clearTimeout(t); t=setTimeout(renderCatalogo,200);} })());
  $('#btnExport').addEventListener('click', () => {
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const blob = new Blob([JSON.stringify(state.books, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'fantasy-italia-nuove-proposte.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // === NOTIZIE ===
  function sanitizeHtml(html){
    try{
      const allowed = new Set(['B','I','U','EM','STRONG','P','BR','UL','OL','LI','A','SPAN','H3','H4']);
      const doc = new DOMParser().parseFromString('<div>'+html+'</div>','text/html');
      const root = doc.body.firstChild;
      function clean(node){
        if(node.nodeType===Node.TEXT_NODE) return node.cloneNode();
        if(node.nodeType!==Node.ELEMENT_NODE) return document.createTextNode('');
        const tag = node.tagName;
        if(!allowed.has(tag)){
          const frag = doc.createDocumentFragment();
          node.childNodes.forEach(ch=>frag.appendChild(clean(ch)));
          return frag;
        }
        const el = doc.createElement(tag.toLowerCase());
        if(tag==='A' && node.getAttribute('href')){
          const href = node.getAttribute('href');
          if(/^https?:/i.test(href)){ el.setAttribute('href',href); el.setAttribute('target','_blank'); el.setAttribute('rel','noopener'); }
        }
        if(tag==='SPAN'){
          const cls = node.getAttribute('class')||'';
          if(/\bbigger\b/.test(cls)) el.className='bigger';
          if(/\bsmaller\b/.test(cls)) el.className = el.className ? (el.className+' smaller') : 'smaller';
        }
        node.childNodes.forEach(ch=>el.appendChild(clean(ch)));
        return el;
      }
      const out = document.createElement('div');
      root.childNodes.forEach(ch=>out.appendChild(clean(ch)));
      return out.innerHTML;
    }catch(e){ return html||''; }
  }

  function previewFrom(n){
    const tmp = document.createElement('div'); tmp.innerHTML = n.bodyHtml || '';
    const txt = (tmp.textContent || tmp.innerText || '').trim();
    return txt.slice(0, 400); // sufficiente per 3–4 righe con clamp
  }

  window.renderNews = function(){
    const grid = $('#gridNews'); if(!grid) return;
    const hasAdmin = sessionIsValid();
    $('#newsAdminBar').style.display = hasAdmin ? 'flex' : 'none';
    $('#newsEditor').style.display   = hasAdmin ? ''    : 'none';

    const items = Array.isArray(state.news) ? state.news.slice() : [];
    for(const n of items){ if(!n.ts) n.ts = Date.now(); }
    items.sort((a,b)=> (b.ts||0)-(a.ts||0));
    grid.innerHTML = '';
    if(!items.length){ grid.innerHTML = '<div class="muted">Ancora nessuna notizia.</div>'; return; }

    for(const n of items){
      const card = document.createElement('div'); card.className='news-card';
      const h = document.createElement('h4'); h.textContent = n.title || '(Senza titolo)';
      const prev = document.createElement('div'); prev.className='news-preview'; prev.textContent = previewFrom(n);
      card.appendChild(h); card.appendChild(prev);
      card.addEventListener('click', ()=>{
        $('#newsFullTitle').textContent = n.title || '';
        $('#newsFullBody').innerHTML = sanitizeHtml(n.bodyHtml || '');
        $('#newsOverlay').style.display='block';
        document.body.style.overflow='hidden';
      });
      grid.appendChild(card);
    }
  };

  // Mini editor
  const ed = $('#news_body_html');
  $$('.news-toolbar .mini').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const cmd = btn.getAttribute('data-cmd'); ed && ed.focus();
      if(cmd==='bold') document.execCommand('bold', false, null);
      else if(cmd==='italic') document.execCommand('italic', false, null);
      else if(cmd==='underline') document.execCommand('underline', false, null);
      else if(cmd==='ul') document.execCommand('insertUnorderedList', false, null);
      else if(cmd==='link'){
        const url = prompt('Inserisci URL (https://...)');
        if(url && /^https?:/i.test(url)) document.execCommand('createLink', false, url);
      }else if(cmd==='bigger' || cmd==='smaller'){
        const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
        const range = sel.getRangeAt(0); const span = document.createElement('span');
        span.className = (cmd==='bigger' ? 'bigger' : 'smaller'); range.surroundContents(span);
      }else if(cmd==='clear'){ ed.innerHTML=''; }
    });
  });

  // Salvataggio notizia (senza campo anteprima)
  (function hookSave(){
    const btn = $('#btnSaveNews'); if(!btn) return;
    btn.addEventListener('click', (ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      if(!sessionIsValid()){ alert('Solo admin.'); return; }
      const title = ($('#news_title').value||'').trim();
      const html  = sanitizeHtml($('#news_body_html').innerHTML||'');
      if(!title){ alert('Titolo obbligatorio.'); return; }
      if(!html){ alert('Inserisci un testo.'); return; }
      const item = { id: 'n'+Date.now().toString(36), title, bodyHtml: html, ts: Date.now() };
      if(!Array.isArray(state.news)) state.news = [];
      state.news.push(item); saveNews();
      $('#news_title').value=''; $('#news_body_html').innerHTML='';
      renderNews(); alert('Notizia pubblicata.');
    }, true);
  })();

  // Overlay: torna alla tab Notizie
  $('#btnBackToNews').addEventListener('click', ()=>{
    $('#newsOverlay').style.display='none';
    document.body.style.overflow='';
    const notizieBtn = document.querySelector('button[data-tab="notizie"]');
    if(notizieBtn){ notizieBtn.click(); }
  });

  // Export news
  const btnExportNews = $('#btnExportNews');
  if(btnExportNews){ btnExportNews.addEventListener('click', ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const blob = new Blob([JSON.stringify(state.news||[], null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='news.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }); }

  // Init
  (function init(){
    // nascondi tutte le tab tranne Catalogo
    $$('.tab').forEach(s => s.style.display='none');
    $('#catalogo').style.display='';
    applyAdminUI();
    renderCatalogo();
  })();
})();
</script>
</body>
</html>
