<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fantasy Italia — Nuove proposte</title>
<meta name="theme-color" content="#7aa6ff">
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root{
    --bg:#0f1013; --panel:#171923; --ink:#e7e9ee; --muted:#a9adbb;
    --accent:#7aa6ff; --danger:#ff6b6b; --border:#232635; --green:#1f6f4a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,Noto Sans;background:linear-gradient(180deg,#0f1013,#0d0e12 140vh);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:rgba(13,14,18,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0;letter-spacing:.2px;flex:1}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:var(--panel);color:var(--ink);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  nav button.active{outline:2px solid var(--accent)}
  .adminBadge{font-size:12px;border:1px solid var(--border);padding:6px 9px;border-radius:999px;color:#cfe;opacity:.9}
  .adminToggle{background:#132033;border:1px solid var(--border);color:#dfe;padding:8px 12px;border-radius:10px;cursor:pointer}
  main{padding:20px 16px}
  section{max-width:1100px;margin:0 auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{position:relative;background:#10121a;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start;min-height:140px}
  .badge{position:absolute;top:8px;left:8px;background:#0f2; color:#072; font-weight:700; font-size:11px; padding:4px 6px;border-radius:6px; border:1px solid #063}
  img.cover{display:block;border-radius:8px;border:1px solid var(--border);max-height:16.6vh;width:auto;object-fit:cover;background:#080a0f}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0 0 6px 0;font-size:16px;line-height:1.2}
  .meta .by{color:var(--muted);font-size:13px;margin-bottom:6px}
  .meta .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:12px;padding:4px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .tag.ok{color:#0d3;border-color:#174}
  .tag.pending{color:#fa6;border-color:#542}
  .tag.label{color:#9fc8ff;border-color:#2854aa}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{background:#151826;border:1px solid var(--border);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px}
  .btn.primary{outline:2px solid var(--accent)}
  .btn.danger{outline:1px solid #402;color:#ff9aa9}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:180px}
  .field label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="url"], input[type="number"], textarea, select{background:#0f1119;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  textarea{height:90px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  footer{color:var(--muted);font-size:12px;padding:16px;text-align:center}
  footer a{color:#9fc8ff;text-decoration:none}
  footer .sep{opacity:.4;margin:0 8px}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .banner{background:#142036;border:1px solid #223a66;color:#cfe;border-radius:12px;padding:8px 12px;margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Fantasy Italia — Nuove proposte</h1>
    <span id="adminBadge" class="adminBadge" style="display:none"></span>
    <button id="adminToggle" class="adminToggle" title="Accedi/Esci come admin">Accedi admin</button>
  </div>
  <div class="wrap" style="padding-top:0">
    <nav id="navPublic">
      <button data-tab="catalogo" class="active">Catalogo</button>
      <button data-tab="nuovo">Nuovo titolo</button>
    </nav>
    <nav id="navAdmin" style="display:none">
      <button data-tab="moderazione">Moderazione</button>
      <button data-tab="impostazioni">Impostazioni</button>
    </nav>
  </div>
</header>

<main>
  <section id="catalogo" class="tab">
    <div id="banner" class="banner" style="display:none"></div>
    <div class="toolbar">
      <div class="field" style="max-width:200px">
        <label>Anno ≥</label>
        <select id="filterYear">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="all" selected>Tutti</option>
        </select>
      </div>
      <input id="q" type="text" placeholder="Cerca titolo, autore, editore…" style="flex:1;min-width:200px">
      <span id="adminTools" style="display:none; gap:8px">
        <button class="btn right" id="btnExport">Esporta JSON</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none">
        <button class="btn" id="btnImport">Importa JSON</button>
      </span>
    </div>
    <div id="gridCatalogo" class="grid"></div>
  </section>

  <section id="nuovo" class="tab" style="display:none">
    <div class="row">
      <div class="field"><label>Titolo</label><input id="f_title" type="text"></div>
      <div class="field"><label>Autore</label><input id="f_author" type="text"></div>
      <div class="field"><label>Anno</label><input id="f_year" type="number" min="1900" max="2100" value="2025"></div>
    </div>
    <div class="row">
      <div class="field"><label>Editore</label><input id="f_publisher" type="text"></div>
      <div class="field"><label>ISBN</label><input id="f_isbn" type="text" placeholder="es. 978..."></div>
      <div class="field"><label>Link store</label><input id="f_store" type="url" placeholder="https://..."></div>
    </div>
    <div class="row">
      <div class="field"><label>URL copertina</label><input id="f_cover" type="url" placeholder="https://..."></div>
      <div class="field"><label>Confermo che è romanzo d’esordio (nel fantasy)</label>
        <select id="f_debut">
          <option value="unknown" selected>Da verificare</option>
          <option value="yes">Sì</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Descrizione (sinossi)</label>
      <textarea id="f_desc"></textarea>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnSaveNew">Salva (in revisione)</button>
      <span class="hint">I contenuti inviati dagli utenti restano in “Revisione” finché non li approva un admin.</span>
    </div>
  </section>

  <section id="moderazione" class="tab" style="display:none">
    <div class="toolbar">
      <div class="field" style="max-width:220px">
        <label>Mostra</label>
        <select id="moderationFilter">
          <option value="pending" selected>In revisione</option>
          <option value="approved">Approvati</option>
          <option value="all">Tutti</option>
        </select>
      </div>
    </div>
    <div id="gridModeration" class="grid"></div>
  </section>

  <section id="impostazioni" class="tab" style="display:none">
    <h3>Impostazioni sito</h3>
    <div class="small muted" style="margin-bottom:10px">Gli URL remoti consentono di centralizzare credenziali e catalogo.</div>
    <div class="row">
      <div class="field">
        <label>URL remoto admins.json</label>
        <input id="adminsUrl" type="url" placeholder="https://tuodominio/data/admins.json">
      </div>
      <div class="field">
        <label>URL remoto catalogo.json</label>
        <input id="catalogUrl" type="url" placeholder="https://tuodominio/data/catalogo.json">
      </div>
      <button class="btn" id="btnSaveUrls">Salva URL</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnClearLocal">Svuota cache locale</button>
      <button class="btn" id="btnForceReload">Ricarica dal remoto (sovrascrivi)</button>
    </div>
    <div class="divider"></div>
    <h3>Amministratori</h3>
    <div class="small muted">Login centralizzato con hash PBKDF2 da <a href="admin-tool.html" target="_blank" rel="noopener">admin-tool</a>.</div>
    <div class="actions" style="margin-top:12px">
      <button class="btn danger" id="btnLogout">Esci dalla sessione admin</button>
    </div>
  </section>
</main>

<footer>
  <div>Fantasy Italia — Nuove proposte è un catalogo collaborativo dedicato alla narrativa fantasy italiana contemporanea.</div>
  <div style="margin-top:6px">
    <a href="legal.html">Note legali & privacy</a><span class="sep">•</span>
    <a href="mailto:simonegrosso.writer@gmail.com">Contatti</a>
  </div>
</footer>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // --- Keys & defaults (v38) ---
  const ADMIN_TIMEOUT_MS = 30 * 60 * 1000;
  const DEFAULT_ADMINS_URL = location.origin + location.pathname.replace(/\/[^\/]*$/, '/') + 'data/admins.json?v=20250812';
  const DEFAULT_CATALOG_URL = location.origin + location.pathname.replace(/\/[^\/]*$/, '/') + 'data/catalogo.json?v=20250812';

  const state = {
    books: loadBooks(),
    nextId: Date.now(),
    settings: loadSettings(),
    isAdmin: false,
    meUser: null,
    remoteAdmins: []
  };

  function loadSettings(){ try{ return JSON.parse(localStorage.getItem('fi_settings_site_v38')||'{}'); }catch(e){ return {}; } }
  function saveSettings(){ localStorage.setItem('fi_settings_site_v38', JSON.stringify(state.settings)); }
  function loadBooks(){ try{ return JSON.parse(localStorage.getItem('fi_books_site_v38')||'[]'); }catch(e){ return []; } }
  function saveBooks(){ localStorage.setItem('fi_books_site_v38', JSON.stringify(state.books)); }

  if(!state.settings.adminsUrl) state.settings.adminsUrl = DEFAULT_ADMINS_URL;
  if(!state.settings.catalogUrl) state.settings.catalogUrl = DEFAULT_CATALOG_URL;
  saveSettings();

  // --- Utilities ---
  function showBanner(msg){ const b = $('#banner'); if(!b) return; b.textContent = msg; b.style.display=''; setTimeout(()=>{b.style.display='none';}, 4000); }
  function now(){ return Date.now(); }
  function truncate(s, n){ return (s && s.length>n) ? (s.slice(0,n-1)+'…') : (s||''); }
  function placeholderCover(){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="240" height="360"><rect width="100%" height="100%" fill="#0a0c12"/><rect x="1" y="1" width="238" height="358" fill="none" stroke="#232635"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="14" fill="#5e657a">Copertina</text></svg>`);
  }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
  async function fetchJson(url){ const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json(); }

  // --- Remote sync ---
  (async function syncCatalogOnStartup(){
    try{
      const data = await fetchJson(state.settings.catalogUrl);
      if(Array.isArray(data)){
        let added=0;
        for(const r of data){
          if(state.books.some(b => sameKey(b,r))) continue;
          state.books.push(normalize(r)); added++;
        }
        if(added>0){ saveBooks(); showBanner('Catalogo aggiornato dal remoto (+'+added+')'); }
      }
    }catch(e){ console.warn('Catalog remote load failed:', e); }
    renderCatalogo();
  })();

  (async function loadRemoteAdmins(){
    try{ const data = await fetchJson(state.settings.adminsUrl); if(Array.isArray(data)) state.remoteAdmins = data; }
    catch(e){ console.warn('Admins remote load failed:', e); }
    // Try autologin if session exists
    if(sessionIsValid()){ state.isAdmin=true; state.meUser=sessionStorage.getItem('fi_admin_user'); applyAdminUI(); touchSession(); }
  })();

  function normalize(r){
    return {
      id: r.id || ('b'+(state.nextId++)),
      title: r.title||'',
      author: r.author||'',
      year: parseInt(r.year||'0',10),
      publisher: r.publisher||'',
      isbn: r.isbn||'',
      storeUrl: r.storeUrl||'',
      coverUrl: r.coverUrl||'',
      description: r.description||'',
      isDebut: (typeof r.isDebut==='boolean'? r.isDebut : null),
      labels: Array.isArray(r.labels)? r.labels.slice(0,12) : [],
      status: r.status||'approved',
      featured: !!r.featured
    };
  }
  function sameKey(b, r){
    const t1 = (b.title||'').toLowerCase().trim();
    const a1 = (b.author||'').toLowerCase().trim();
    const i1 = (b.isbn||'').replace(/[^0-9xX]+/g,'');
    const t2 = (r.title||'').toLowerCase().trim();
    const a2 = (r.author||'').toLowerCase().trim();
    const i2 = (r.isbn||'').replace(/[^0-9xX]+/g,'');
    return (i1 && i2 && i1===i2) || (t1===t2 && a1===a2);
  }

  // --- Admin session ---
  function sessionIsValid(){
    const u = sessionStorage.getItem('fi_admin_user');
    const t = parseInt(sessionStorage.getItem('fi_admin_time')||'0',10);
    if(!u || !t) return false;
    if(now() - t > ADMIN_TIMEOUT_MS) return false;
    return (state.remoteAdmins||[]).some(a=>a.u===u);
  }
  function touchSession(){ sessionStorage.setItem('fi_admin_time', String(now())); }
  function clearSession(){ sessionStorage.removeItem('fi_admin_user'); sessionStorage.removeItem('fi_admin_time'); }
  async function pbkdf2Hex(pass, saltHex, iters, length=32){
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveBits']);
    const salt = new Uint8Array(saltHex.match(/.{1,2}/g).map(b=>parseInt(b,16)));
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations:iters}, key, length*8);
    return [...new Uint8Array(bits)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  async function doLoginFlow(){
    const u = prompt('Inserisci username admin');
    if(u===null || !u.trim()) return false;
    const p = prompt('Inserisci password admin');
    if(p===null) return false;
    const rec = (state.remoteAdmins||[]).find(a => a.u===u);
    if(!rec){ alert('Credenziali non valide.'); return false; }
    const h = await pbkdf2Hex(p, rec.salt, rec.iter||120000, 32);
    if(h !== rec.hash){ alert('Credenziali non valide.'); return false; }
    state.isAdmin = true; state.meUser = u;
    sessionStorage.setItem('fi_admin_user', u);
    touchSession();
    applyAdminUI();
    return true;
  }

  // --- UI wiring ---
  function applyAdminUI(){
    const on = state.isAdmin;
    $('#navAdmin').style.display = on ? '' : 'none';
    $('#adminBadge').style.display = on ? '' : 'none';
    $('#adminBadge').textContent = on ? ('Admin: '+state.meUser) : '';
    $('#adminToggle').textContent = on ? 'Esci admin' : 'Accedi admin';
    $('#adminTools').style.display = on ? 'flex' : 'none';
  }

  // Tabs
  $$('#navPublic button, #navAdmin button').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      if(tab==='moderazione' || tab==='impostazioni'){
        if(!sessionIsValid()){ state.isAdmin=false; state.meUser=null; clearSession(); applyAdminUI(); alert('Area riservata: accedi come admin.'); return; }
        touchSession();
      }
      $$('.tab').forEach(s => s.style.display='none');
      $('#'+tab).style.display='';
      $$('#navPublic button, #navAdmin button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      if(tab==='moderazione') renderModeration();
      if(tab==='impostazioni') renderSettings();
    });
  });

  // Admin toggle
  $('#adminToggle').addEventListener('click', async () => {
    if(state.isAdmin){ state.isAdmin=false; state.meUser=null; clearSession(); applyAdminUI(); return; }
    await doLoginFlow();
  });

  // --- Impostazioni ---
  function renderSettings(){
    $('#adminsUrl').value = state.settings.adminsUrl || DEFAULT_ADMINS_URL;
    $('#catalogUrl').value = state.settings.catalogUrl || DEFAULT_CATALOG_URL;
  }
  $('#btnSaveUrls').addEventListener('click', ()=>{
    state.settings.adminsUrl = $('#adminsUrl').value.trim() || DEFAULT_ADMINS_URL;
    state.settings.catalogUrl = $('#catalogUrl').value.trim() || DEFAULT_CATALOG_URL;
    saveSettings();
    alert('URL salvati. Ricarica la pagina per ricaricare le sorgenti remote.');
  });
  $('#btnLogout').addEventListener('click', ()=>{ clearSession(); state.isAdmin=false; state.meUser=null; applyAdminUI(); alert('Sei uscito dalla sessione admin.'); });

  // Cache tools
  $('#btnClearLocal').addEventListener('click', ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    if(confirm('Svuotare la cache locale (catalogo e sessione)?')){
      const keep = localStorage.getItem('fi_settings_site_v38');
      localStorage.clear();
      if(keep) localStorage.setItem('fi_settings_site_v38', keep);
      sessionStorage.clear();
      alert('Cache locale svuotata. Ricarica la pagina.');
    }
  });
  $('#btnForceReload').addEventListener('click', async ()=>{
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    if(!confirm('Sovrascrivere il catalogo locale con la versione remota?')) return;
    try{
      const data = await fetchJson(state.settings.catalogUrl);
      if(!Array.isArray(data)) throw new Error('catalogo.json non è un array');
      state.books = data.map(normalize);
      saveBooks();
      renderCatalogo();
      alert('Catalogo ricaricato dal remoto.');
    }catch(e){ alert('Errore ricarica: '+(e && e.message ? e.message : e)); }
  });

  // --- Nuovo titolo ---
  function collectForm(){
    return {
      title: $('#f_title').value.trim(),
      author: $('#f_author').value.trim(),
      year: parseInt($('#f_year').value||'0',10),
      publisher: $('#f_publisher').value.trim(),
      isbn: $('#f_isbn').value.trim(),
      storeUrl: $('#f_store').value.trim(),
      coverUrl: $('#f_cover').value.trim(),
      description: $('#f_desc').value.trim(),
      isDebut: (function(){ const v=$('#f_debut').value; if(v==='yes') return true; if(v==='no') return false; return null; })(),
      status: 'pending',
      labels: [],
      featured: false
    };
  }
  function clearForm(){
    ['f_title','f_author','f_publisher','f_isbn','f_store','f_cover','f_desc'].forEach(id=> $('#'+id).value='');
    $('#f_year').value = new Date().getFullYear(); $('#f_debut').value = 'unknown';
  }
  $('#btnSaveNew').addEventListener('click', () => {
    const b = collectForm();
    if(!b.title || !b.author){ alert('Titolo e Autore sono obbligatori.'); return; }
    addBook(b); clearForm(); alert('Titolo salvato in Revisione.');
  });

  // --- Catalogo ---
  $('#filterYear').addEventListener('change', renderCatalogo);
  $('#q').addEventListener('input', debounce(renderCatalogo, 200));

  $('#btnExport').addEventListener('click', () => {
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const blob = new Blob([JSON.stringify(state.books, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'fantasy-italia-nuove-proposte.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  $('#btnImport').addEventListener('click', () => {
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    $('#fileImport').click();
  });
  $('#fileImport').addEventListener('change', async (e) => {
    if(!sessionIsValid()){ alert('Solo admin.'); return; }
    const file = e.target.files[0]; if(!file) return;
    try{
      const txt = await file.text(); const data = JSON.parse(txt);
      if(Array.isArray(data)){ state.books = data.map(normalize); saveBooks(); renderCatalogo(); alert('Import riuscito: '+data.length+' record.'); }
      else alert('JSON non valido.');
    }catch(err){ alert('Errore nel parsing JSON.'); }
  });

  function addBook(b){ b.id = 'b'+(state.nextId++); if(!Array.isArray(b.labels)) b.labels = []; state.books.push(b); saveBooks(); renderCatalogo(); }

  function tagEl(text, cls='tag'){ const t=document.createElement('span'); t.className=cls; t.textContent=text; return t; }

  function bookCard(b, opts){
    const el = document.createElement('div'); el.className='card';
    if(b.featured){ const bd=document.createElement('div'); bd.className='badge'; bd.textContent='Consigliato'; el.appendChild(bd); }
    const img = document.createElement('img'); img.className='cover'; img.alt='Copertina'; img.src = b.coverUrl || placeholderCover();
    const meta = document.createElement('div'); meta.className='meta';
    const h3 = document.createElement('h3'); h3.textContent = b.title || '(Senza titolo)';
    const by = document.createElement('div'); by.className='by'; by.textContent = [b.author, b.publisher, b.year].filter(Boolean).join(' • ');
    const desc = document.createElement('div'); desc.className='small muted'; desc.textContent = b.description ? truncate(b.description, 200) : '';
    const tags = document.createElement('div'); tags.className='tags';
    const st = tagEl((b.status==='approved')?'Approvato':'In revisione', 'tag '+(b.status==='approved'?'ok':'pending'));
    const db = tagEl((b.isDebut===true)?'Esordio: sì' : (b.isDebut===false?'Esordio: no':'Esordio: ?'));
    tags.appendChild(st); tags.appendChild(db);
    if(Array.isArray(b.labels)){ b.labels.slice(0,6).forEach(l => tags.appendChild(tagEl(l, 'tag label'))); }
    const actions = document.createElement('div'); actions.className='actions';
    if(b.storeUrl){ const a = document.createElement('a'); a.href=b.storeUrl; a.target='_blank'; a.rel='noopener'; a.textContent='Apri store'; a.className='btn'; actions.appendChild(a); }
    if(opts && opts.showModeration){
      const approve = document.createElement('button'); approve.className='btn primary'; approve.textContent='Approva';
      approve.addEventListener('click', ()=>{ b.status='approved'; saveBooks(); renderModeration(); });
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Elimina';
      del.addEventListener('click', ()=>{ if(confirm('Eliminare questo titolo?')){ state.books = state.books.filter(x => x.id!==b.id); saveBooks(); renderModeration(); }});
      const toggleDeb = document.createElement('button'); toggleDeb.className='btn'; toggleDeb.textContent='Toggle esordio';
      toggleDeb.addEventListener('click', ()=>{ b.isDebut = (b.isDebut===true)?false:(b.isDebut===false?null:true); saveBooks(); renderModeration(); });
      const toggleFeat = document.createElement('button'); toggleFeat.className='btn'; toggleFeat.textContent = b.featured ? 'Rimuovi Consigliato' : 'Consiglia';
      toggleFeat.addEventListener('click', ()=>{ b.featured = !b.featured; saveBooks(); renderModeration(); if(typeof renderCatalogo==='function') renderCatalogo(); });
      const labelIn = document.createElement('input'); labelIn.type='text'; labelIn.placeholder='Aggiungi etichetta (es. Vincitore Premio Odissea)'; labelIn.className='btn'; labelIn.style.minWidth='240px';
      const addLabel = document.createElement('button'); addLabel.className='btn'; addLabel.textContent='Aggiungi etichetta';
      addLabel.addEventListener('click', ()=>{ const t=(labelIn.value||'').trim(); if(!t) return; if(!Array.isArray(b.labels)) b.labels=[]; if(b.labels.length>=12){ alert('Troppi tag.'); return; } if(!b.labels.includes(t)){ b.labels.push(t); saveBooks(); renderModeration(); } labelIn.value=''; });
      actions.appendChild(approve); actions.appendChild(del); actions.appendChild(toggleDeb); actions.appendChild(toggleFeat); actions.appendChild(labelIn); actions.appendChild(addLabel);
    }
    meta.appendChild(h3); meta.appendChild(by); meta.appendChild(desc); meta.appendChild(tags); meta.appendChild(actions);
    el.appendChild(img); el.appendChild(meta);
    if(opts && opts.showModeration && Array.isArray(b.labels) && b.labels.length){
      const wrap = document.createElement('div'); wrap.className='tags';
      b.labels.forEach((t,i)=>{ const chip=document.createElement('span'); chip.className='tag label'; chip.textContent=t+' ✕'; chip.style.cursor='pointer'; chip.addEventListener('click', ()=>{ b.labels = b.labels.filter(x=>x!==t); saveBooks(); renderModeration(); }); wrap.appendChild(chip); });
      meta.appendChild(wrap);
    }
    return el;
  }

  function renderCatalogo(){
    const grid = $('#gridCatalogo'); grid.innerHTML='';
    const q = $('#q').value.toLowerCase().trim();
    const fy = $('#filterYear').value;
    let list = [...state.books];
    if(fy!=='all'){ const y = parseInt(fy,10); list = list.filter(b => (parseInt(b.year,10)||0) >= y); }
    if(q){ list = list.filter(b => (b.title||'').toLowerCase().includes(q) || (b.author||'').toLowerCase().includes(q) || (b.publisher||'').toLowerCase().includes(q)); }
    if(!list.length){ grid.innerHTML = '<div class="muted">Nessun risultato. Il catalogo viene caricato dal server all’avvio.</div>'; return; }
    list.sort((a,b)=>{
      if(!!b.featured !== !!a.featured) return (b.featured?1:0) - (a.featured?1:0); // featured first
      const ya = parseInt(a.year,10)||0; const yb = parseInt(b.year,10)||0;
      if(yb!==ya) return yb - ya;
      const ta = (a.title||'').toLocaleLowerCase(); const tb = (b.title||'').toLocaleLowerCase();
      return ta.localeCompare(tb,'it');
    });
    for(const b of list){ grid.appendChild(bookCard(b, {showModeration:false})); }
  }

  function renderModeration(){
    const grid = $('#gridModeration'); grid.innerHTML='';
    const f = $('#moderationFilter').value;
    let list = [...state.books];
    if(f!=='all') list = list.filter(b => b.status===f);
    list.sort((a,b)=>{
      const ya = parseInt(a.year,10)||0; const yb = parseInt(b.year,10)||0;
      if(yb!==ya) return yb - ya;
      const ta = (a.title||'').toLocaleLowerCase(); const tb = (b.title||'').toLocaleLowerCase();
      return ta.localeCompare(tb,'it');
    });
    if(!list.length){ grid.innerHTML = '<div class="muted">Nulla da mostrare.</div>'; return; }
    for(const b of list){ grid.appendChild(bookCard(b, {showModeration:true})); }
  }

  // Init
  (function init(){ $$('.tab').forEach(s => s.style.display='none'); $('#catalogo').style.display=''; renderCatalogo(); })();
})();
</script>
</body>
</html>
